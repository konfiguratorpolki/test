<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-DNBGJLP2FN"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-DNBGJLP2FN');
    </script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Konfigurator P√≥≈Çki</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css" />
    <style>
        /* Style niestandardowe */
        ul.list-none { list-style-type: none; padding-left: 0; }

        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        .instruction-list li { display: flex; align-items: start; margin-bottom: 0.75rem; }
        .instruction-list li svg { width: 1.25rem; height: 1.25rem; margin-right: 0.75rem; flex-shrink: 0; margin-top: 0.125rem; color: #16A34A; }

        /* ---- Style dla wysuwanego panelu 3D (Mobile) ---- */
        @media (max-width: 767px) {
            #shelfContainer {
                position: fixed !important; bottom: 0; left: 0; right: 0;
                width: 100% !important; height: 45vh !important; max-width: none !important;
                background-color: #ffffff !important;
                box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.15) !important;
                border-top-left-radius: 1rem !important; border-top-right-radius: 1rem !important;
                z-index: 1000 !important;
                transform: translateY(100%); visibility: hidden !important;
                transition: transform 0.35s ease-in-out, visibility 0s linear 0.35s !important;
                padding: 0 !important; display: flex !important; flex-direction: column !important;
                overflow: hidden !important; margin-bottom: 0 !important;
            }
            #shelfContainer.active {
                transform: translateY(0) !important; visibility: visible !important;
                transition: transform 0.35s ease-in-out, visibility 0s linear 0s !important;
            }
             #threeJsCanvasWrapper {
                 width: 100% !important; height: 100% !important; min-height: initial !important;
                 border-radius: 0 !important; background-color: #F5F5F4 !important;
                 cursor: grab !important; flex-grow: 1 !important; margin: 0 !important;
                 padding: 0 !important; position: relative !important; overflow: hidden !important;
             }
             #threeJsCanvasWrapper:active { cursor: grabbing !important; }
             #modalOverlay { display: none !important; }

            /* ---- STYLE DLA PRZYCISKU ZWIJANIA ---- */
             #collapse3dPanelButton {
                display: flex !important; align-items: center; justify-content: center;
                position: absolute !important; top: 0.5rem; right: 0.5rem; z-index: 1002 !important;
                width: 2.5rem; height: 2.5rem; background-color: rgba(255, 255, 255, 0.7) !important;
                backdrop-filter: blur(4px) !important; border-radius: 9999px !important;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important; cursor: pointer;
                transition: background-color 0.2s ease, transform 0.1s ease;
             }
             #collapse3dPanelButton:hover { background-color: rgba(255, 255, 255, 0.9) !important; }
             #collapse3dPanelButton:active { transform: scale(0.95); }
             #collapse3dPanelButton svg { width: 1.5rem; height: 1.5rem; color: #374151; }

            /* ---- Style dla ikon nawigacyjnych (lewy dolny r√≥g) ---- */
            #shelfContainer.active #mobilePanelIcons {
                display: flex !important; flex-direction: column; position: absolute !important;
                /* Usuniƒôto bottom: 2.5rem, wracamy do bottom: 0.5rem bo nie ma ju≈º paska info */
                left: 0.5rem; bottom: 0.5rem;
                z-index: 1001 !important; gap: 0.5rem;
            }
            #mobilePanelIcons button {
               display: flex; flex-direction: column; align-items: center; justify-content: center;
               width: 65px; height: 65px; padding: 0.5rem; background-color: rgba(255, 255, 255, 0.8);
               backdrop-filter: blur(6px); border: 1px solid rgba(255, 255, 255, 0.3);
               border-radius: 0.875rem; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0,0,0,0.08);
               cursor: pointer; transition: background-color 0.2s ease-in-out, transform 0.15s ease-in-out, box-shadow 0.2s ease-in-out, border-color 0.2s ease-in-out;
               color: #374151; overflow: hidden;
            }
            #mobilePanelIcons button:hover { background-color: rgba(255, 255, 255, 0.95); box-shadow: 0 6px 15px rgba(0, 0, 0, 0.12), 0 2px 5px rgba(0,0,0,0.1); transform: translateY(-2px); color: #16A34A; }
            #mobilePanelIcons button:active { transform: translateY(0px) scale(0.96); box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); background-color: rgba(240, 240, 240, 0.85); }
            #mobilePanelIcons button svg { width: 1.75rem; height: 1.75rem; margin-bottom: 0.15rem; transition: color 0.2s ease-in-out, transform 0.15s ease-in-out; color: #4b5563; }
            #mobilePanelIcons button:hover svg { color: #16A34A; transform: scale(1.); }
            #mobilePanelIcons button span { font-size: 0.6rem; line-height: 0.75rem; font-weight: 600; text-align: center; display: block; transition: color 0.2s ease-in-out; }
            #mobilePanelIcons button.mobile-icon-active { background-color: rgba(220, 252, 231, 0.9); border-color: rgba(22, 163, 74, 0.4); color: #15803d; box-shadow: 0 4px 12px rgba(22, 163, 74, 0.15), 0 2px 4px rgba(0,0,0,0.08); }
            #mobilePanelIcons button.mobile-icon-active svg { color: #15803d; }
        }
        /* ---- Koniec styl√≥w dla panelu 3D (Mobile) ---- */

        /* Oryginalne style #shelfContainer dla desktopu */
        @media (min-width: 768px) {
             #shelfContainer {
                 position: static; bottom: auto; left: auto; right: auto; width: 100%;
                 height: 500px; max-width: 500px; background-color: #F5F5F4; box-shadow: none;
                 border-radius: 0.5rem; z-index: auto; transform: none; visibility: visible;
                 transition: none; padding: 0; display: block; flex-direction: initial;
                 overflow: hidden; margin-bottom: 0.5rem; cursor: grab;
             }
             #collapse3dPanelButton { display: none !important; }
             #mobilePanelIcons { display: none !important; }
             #threeJsCanvasWrapper { width: 100%; height: 100%; min-height: initial; border-radius: inherit; background-color: transparent; cursor: inherit; flex-grow: initial; position: static; overflow: hidden; }
             #threeJsCanvasWrapper:active { cursor: grabbing; }
             #modalOverlay { display: none !important; }
        }

        /* Reszta styl√≥w podstawowych */
        input[type=range] { -webkit-appearance: none; appearance: none; width: 100%; height: 8px; background: #D6D3D1; border-radius: 5px; outline: none; opacity: 0.7; transition: opacity .2s; }
        input[type=range]:hover { opacity: 1; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; background: #16A34A; border-radius: 50%; cursor: pointer; transition: background-color 0.15s ease-in-out; }
        input[type=range]::-webkit-slider-thumb:active { background: #15803d; }
        input[type=range]::-moz-range-thumb { width: 20px; height: 20px; background: #16A34A; border-radius: 50%; cursor: pointer; border: none; transition: background-color 0.15s ease-in-out; }
        input[type=range]::-moz-range-thumb:active { background: #15803d; }
        .review-fade-enter { opacity: 0; transition: opacity 700ms ease-in-out; }
        .review-fade-enter-active { opacity: 1; }
        details.color-samples-details { margin-top: 1rem; }
        details.color-samples-details > summary { list-style: none; cursor: pointer; padding: 0.5rem 0; display: flex; justify-content: space-between; align-items: center; color: #57534E; font-size: 0.875rem; font-weight: 500; transition: color 0.2s ease; border-top: 1px dashed #E7E5E4; padding-top: 0.75rem; }
        details.color-samples-details > summary::-webkit-details-marker { display: none; }
        details.color-samples-details > summary::marker { display: none; }
        details.color-samples-details > summary:hover { color: #16A34A; }
        details.color-samples-details > summary .summary-chevron { transition: transform 0.2s ease-in-out; color: #A8A29E; }
        details[open].color-samples-details > summary .summary-chevron { transform: rotate(180deg); color: #16A34A; }
        #materialSwiper { width: 100%; height: 250px; margin-top: 0.75rem; border-radius: 0.375rem; background-color: #E7E5E4; position: relative; overflow: hidden; }
        @media (min-width: 768px) { #materialSwiper { height: 250px; } }
        #materialSwiper .swiper-slide { text-align: center; font-size: 18px; background: #fff; display: flex; flex-direction: column; justify-content: center; align-items: center; overflow: hidden; }
        #materialSwiper .swiper-slide img { display: block; width: 100%; height: 100%; object-fit: cover; border-radius: 0.5rem;}
        #materialSwiper .material-name { position: absolute; bottom: 0; left: 0; width: 100%; background-color: rgba(0, 0, 0, 0.6); color: white; padding: 0.375rem 0.75rem; font-size: 0.875rem; text-align: center; }
        .material-swiper-button-prev, .material-swiper-button-next { position: absolute; top: 50%; transform: translateY(-50%); z-index: 10; cursor: pointer; background-color: rgba(255, 255, 255, 0.7); border-radius: 50%; width: 2.5rem; height: 2.5rem; display: flex; align-items: center; justify-content: center; color: #44403C; transition: background-color 0.2s ease; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .material-swiper-button-prev:hover, .material-swiper-button-next:hover { background-color: rgba(255, 255, 255, 0.9); color: #16A34A; }
        .material-swiper-button-prev { left: 10px; } .material-swiper-button-next { right: 10px; }
        .material-swiper-button-prev::after, .material-swiper-button-next::after { font-family: 'swiper-icons'; font-size: 1rem; font-weight: bold; }
        .material-swiper-button-prev.swiper-button-disabled, .material-swiper-button-next.swiper-button-disabled { opacity: 0.35; cursor: auto; pointer-events: none; }
        details:not(.color-samples-details) summary { list-style: none; cursor: pointer; }
        details:not(.color-samples-details) summary::-webkit-details-marker { display: none; }
        details:not(.color-samples-details) summary::marker { display: none; }
        details:not(.color-samples-details) summary .marker { transition: transform 0.2s ease-in-out; margin-left: auto; }
        details[open]:not(.color-samples-details) summary .marker { transform: rotate(180deg); }
        details:not(.color-samples-details) summary { position: relative; }
        details:not(.color-samples-details) summary::before { content: ''; display:none; }
        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border-width: 0; }
        select.custom-select { -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%236B7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E"); background-position: right 0.75rem center; background-repeat: no-repeat; background-size: 1.25em 1.25em; padding-right: 2.75rem; padding-top: 0.5rem; padding-bottom: 0.5rem; padding-left: 0.75rem; border-width: 1px; border-color: #A8A29E; border-radius: 0.375rem; background-color: #FFFFFF; transition: all 150ms ease-in-out; width: 100%; }
        select.custom-select:focus { outline: 2px solid transparent; outline-offset: 2px; --tw-ring-offset-shadow: var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color); --tw-ring-shadow: var(--tw-ring-inset) 0 0 0 calc(2px + var(--tw-ring-offset-width)) var(--tw-ring-color); box-shadow: var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000); --tw-ring-offset-width: 1px; --tw-ring-color: #16A34A; border-color: #16A34A; }
        select.custom-select:disabled { background-color: #F5F5F4; color: #A8A29E; cursor: not-allowed; border-color: #E7E5E4; background-image: none; }
        .color-swatch-display { display: inline-block; width: 1.25rem; height: 1.25rem; border-radius: 0.25rem; margin-left: 0.5rem; vertical-align: middle; background-color: #E5E7EB; border: 1px solid #D1D5DB; box-shadow: inset 0 0 0 1px rgba(0,0,0,0.05); transition: background-color 0.2s ease-in-out; flex-shrink: 0; }
        .color-swatch-display.swatch-white-display { border-color: #9CA3AF; }
        @keyframes bounce { 0%, 20%, 50%, 80%, 100% {transform: translateY(0);} 40% {transform: translateY(-10px);} 60% {transform: translateY(-5px);} }
        .icon-bounce { animation: bounce 1s infinite; }
        @keyframes bg-pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.85; } }
        .animate-bg-pulse { animation: bg-pulse 3s infinite ease-in-out; }
        @keyframes icon-rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .animate-icon-rotate { animation: icon-rotate 15s linear infinite; }
        @keyframes gallery-spin { to { transform: rotate(360deg); } }
        #mugShelfDividersOptions label, #mugShelfMountOptions label { display: block; margin-bottom: 0.5rem; cursor: pointer; font-size: 0.875rem; color: #374151; }
        #mugShelfDividersOptions input[type="checkbox"], #mugShelfMountOptions input[type="radio"] { margin-right: 0.5rem; cursor: pointer; border-color: #D1D5DB; color: #16A34A; transition: all 0.15s ease-in-out; }
        #mugShelfDividersOptions input[type="checkbox"] { border-radius: 0.25rem; }
        #mugShelfMountOptions input[type="radio"] { border-radius: 9999px; }
        #mugShelfDividersOptions input[type="checkbox"]:focus, #mugShelfMountOptions input[type="radio"]:focus { ring: 2px; ring-offset-0; ring-green-500; }
        .mug-options-header { text-md font-semibold mb-2 text-stone-700; }
        #mugShelfMountOptions { display: none; margin-top: 1rem; padding-top: 1rem; border-top: 1px dashed #e5e7eb; }
        #mugShelfDividersOptions { display: none; margin-top: 1rem; padding-top: 1rem; border-top: 1px dashed #e5e7eb; }

        /* --- Style Modali --- */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.6); display: none; align-items: center; justify-content: center; z-index: 1050; opacity: 0; transition: opacity 0.3s ease-in-out; }
        .modal-overlay.visible { display: flex; opacity: 1; }
        .modal { position: relative; background-color: #ffffff; border-radius: 0.75rem; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); width: 90%; max-width: 520px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column; transform: translateY(20px) scale(0.95); opacity: 0; transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1), opacity 0.3s ease-in-out; }
        .modal-overlay.visible .modal { transform: translateY(0) scale(1); opacity: 1; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.5rem; border-bottom: 1px solid #e5e7eb; background-color: #f9fafb; }
        .modal-title { font-size: 1.125rem; font-weight: 600; color: #1f2937; }
        .modal-close-button { background: none; border: none; font-size: 1.75rem; line-height: 1; color: #9ca3af; cursor: pointer; padding: 0.25rem; transition: color 0.2s ease, transform 0.1s ease; }
        .modal-close-button:hover { color: #374151; }
        .modal-close-button:active { transform: scale(0.9); }
        .modal-body { padding: 1.25rem 1.5rem; overflow-y: auto; flex-grow: 1; color: #4b5563; }
        .modal-body p, .modal-body li { line-height: 1.6; margin-bottom: 0.75rem; }
        .modal-body strong { color: #374151; }
        .modal-footer { padding: 1rem 1.5rem; background-color: #f9fafb; border-top: 1px solid #e5e7eb; text-align: right; }
        #orderDetailsModal .modal-body h4 { font-weight: 600; margin-top: 1rem; margin-bottom: 0.5rem; color: #111827; }
        #allegroOrderModal .modal-body ol { padding-left: 1.25rem; }
        #allegroOrderModal .modal-body li { margin-bottom: 0.5rem; }
        #allegroOrderModal .modal-footer button { transition: background-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }

        @media (max-width: 640px) {
            .modal { width: 95%; border-radius: 0.5rem; max-width: 95%;}
            .modal-header { padding: 0.75rem 1rem; }
            .modal-title { font-size: 1rem; }
            .modal-close-button { font-size: 1.5rem; }
            .modal-body { padding: 1rem; font-size: 0.9rem; }
            .modal-footer { padding: 0.75rem 1rem; display: flex; flex-direction: column-reverse; gap: 0.75rem; }
            .modal-footer button { width: 100%; margin-left: 0 !important; }
        }
        /* --- Koniec styl√≥w dla modali --- */

        /* Reszta styl√≥w bez zmian */
        #viewOrderSection label { display: block; font-size: 0.875rem; font-weight: 500; color: #57534e; margin-bottom: 0.25rem; }
        #viewOrderSection input[type="text"] { width: 100%; border-radius: 0.375rem; border: 1px solid #d1d5db; padding: 0.5rem 0.75rem; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out; }
        #viewOrderSection input[type="text"]:focus { outline: none; border-color: #10b981; box-shadow: 0 0 0 1px #10b981; }
        #viewOrderSection input[type="text"]:placeholder-shown { font-style: italic; }
        #tabbedGalleryContainer { background-color: #ffffff; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); padding: 1rem; margin-bottom: 1.5rem; border: 1px solid #e5e7eb; }
        .gallery-tabs { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.75rem; }
        .gallery-tab { padding: 0.5rem 1rem; font-size: 0.875rem; font-weight: 600; color: #57534e; background-color: #f5f5f4; border: 1px solid #e5e7eb; border-radius: 0.375rem; cursor: pointer; transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease; white-space: nowrap; }
        .gallery-tab:hover { background-color: #e7e5e4; color: #44403c; }
        .gallery-tab.active { background-color: #16A34A; color: #ffffff; border-color: #15803d; }
        .gallery-content-wrapper { position: relative; width: 100%; overflow: hidden; min-height: 200px; }
        .gallery-image-area { overflow-x: auto; scroll-behavior: smooth; scrollbar-width: none; padding: 12px 2px; position: relative; -webkit-overflow-scrolling: touch; }
        .gallery-image-area::-webkit-scrollbar { display: none; }
        .gallery-grid { display: flex; gap: 20px; width: max-content; }
        .gallery-tile { display: flex; flex-direction: column; align-items: center; width: 260px; flex-shrink: 0; transition: transform 0.35s cubic-bezier(0.25, 0.8, 0.25, 1), box-shadow 0.35s cubic-bezier(0.25, 0.8, 0.25, 1), border-color 0.3s ease-out, opacity 0.3s ease-out; border: 3px solid transparent; border-radius: 10px; padding: 6px; background-color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.05); cursor: pointer; }
        @media (max-width: 768px) { .gallery-grid { gap: 10px; } .gallery-tile { width: 280px; padding: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); } .gallery-image-container { height: 200px; } }
        @media (max-width: 480px) { .gallery-tile { width: 240px; padding: 3px; } .gallery-image-container { height: 180px; } }
        .gallery-tile:hover { transform: translateY(-5px) scale(1.02); box-shadow: 0 10px 20px rgba(0,0,0,0.1), 0 4px 8px rgba(0,0,0,0.08); border-color: #d1d5db; }
        .gallery-tile.gallery-tile--active { transform: translateY(-2px) scale(1.01); opacity: 1 !important; }
        .gallery-image-container { position: relative; width: 100%; height: 180px; border-radius: 6px; overflow: hidden; background: #fff; box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.08); transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1), box-shadow 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); }
        .gallery-image-container img { width: 100%; height: 100%; object-fit: contain; background: #fff; transition: transform 0.35s cubic-bezier(0.25, 0.8, 0.25, 1); }
        .gallery-tile:hover .gallery-image-container img { transform: scale(1.05); }
        .config-btn { position: absolute; bottom: 8px; right: 8px; width: 40px; height: 40px; border-radius: 50%; background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(3px); display: flex; justify-content: center; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.15); cursor: pointer; opacity: 0; pointer-events: none; transform: scale(0.8); transition: opacity 0.3s ease, transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), background-color 0.2s ease; z-index: 5; }
        .gallery-tile:hover .config-btn { opacity: 1; pointer-events: auto; transform: scale(1); }
        .config-btn:hover { background: rgba(22, 163, 74, 0.85); transform: scale(1.1); }
        .config-btn:hover svg { stroke: #ffffff; animation-play-state: running; }
        .config-btn svg { stroke: #374151; fill: none; stroke-width: 1.6; animation: gallery-spin 2.5s linear infinite paused; width: 22px; height: 22px; transition: stroke 0.2s ease; }
        .gallery-tile:hover .config-btn svg { animation-play-state: running; }
        .gallery-caption { margin-top: 8px; font-size: .8em; font-weight: 500; color: #57534E; opacity: 0; transform: translateY(5px); transition: opacity 0.3s ease 0.1s, transform 0.3s ease 0.1s; text-align: center; width: 100%; }
        .gallery-tile:hover .gallery-caption { opacity: 1; transform: translateY(0); }
        .gallery-arrow { position: absolute; top: 50%; transform: translateY(-50%); width: 40px; height: 40px; font-size: 20px; background: #fff; border: 1px solid #e0e0e0; border-radius: 50%; box-shadow: 0 2px 6px rgb(0 0 0 / .12); display: flex; align-items: center; justify-content: center; cursor: pointer; opacity: 0; pointer-events: none; transition: background .2s, box-shadow .2s, opacity .3s, transform 0.2s ease-out; z-index: 10; color: #374151; }
        .gallery-content-wrapper:hover .gallery-arrow { opacity: 1; pointer-events: auto; }
        .gallery-arrow:hover { background: #f0f0f0; box-shadow: 0 3px 9px rgb(0 0 0 /.18); transform: translateY(-50%) scale(1.05); color: #16A34A; }
        .gallery-arrow:active { transform: translateY(-50%) scale(0.95); background: #e7e7e7;}
        .gallery-prev-arrow { left: 12px; } .gallery-next-arrow { right: 12px; }
        #stickyFooterBar { transform: translateY(0); transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out; padding: 0.5rem 0.25rem; height: 60px; z-index: 990; }
        #stickyFooterBar > * { background: none; border: none; padding: 0; margin: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; font-size: 0.75rem; line-height: 1rem; text-align: center; flex-grow: 1; flex-basis: 0; height: 100%; transition: background-color 0.15s ease-in-out; min-width: 0; cursor: pointer; }
        #stickyFooterBar > *:hover, #stickyFooterBar > *:focus { background-color: rgba(255, 255, 255, 0.1); outline: none; border-radius: 0.25rem; }
        #stickyFooterBar button svg, #stickyFooterBar #footerPriceDisplay svg { width: 1.5rem; height: 1.5rem; margin-bottom: 0.125rem; pointer-events: none; }
        #footerPriceDisplay { font-weight: bold; font-size: 0.875rem; line-height: 1.25rem; padding: 0 0.25rem; cursor: default; }
        #footerPriceDisplay > svg { width: 1.25rem; height: 1.25rem; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .animate-spin-slow { animation: spin 4s linear infinite; }
        @keyframes section-highlight-anim { 0% { background-color: rgba(22, 163, 74, 0) !important; } 50% { background-color: rgba(22, 163, 74, 0.15) !important; } 100% { background-color: rgba(22, 163, 74, 0) !important; } }
        .section-highlight-flash { animation: section-highlight-anim 0.75s ease-in-out; }
        .section-highlight-persistent { background-color: rgba(22, 163, 74, 0.08) !important; transition: background-color 0.3s ease-out; border-radius: 0.5rem; }

        /* ---- Style Panelu Sterowania Przegr√≥dkami/Monta≈ºem (Mobile 3D) - Zaktualizowane ---- */
        #mugShelfDividerIconsContainer {
            display: none; flex-direction: column; align-items: stretch;
            position: absolute !important; right: 0.5rem; top: 60%;
            transform: translateY(-50%); z-index: 1001; gap: 0.4rem; padding: 0.6rem;
            background-color: #ffffff; border-radius: 0.75rem; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            min-width: 80px;
        }
        #mugShelfDividerIconsContainer.visible { display: flex !important; }
        .mug-shelf-controls-header { font-size: 0.65rem; font-weight: 600; color: #4b5563; text-align: center; padding-bottom: 0.3rem; text-transform: lowercase; } /* text-transform: lowercase */
        #dividerIconGroup { display: flex; flex-direction: column; align-items: center; gap: 0.3rem; }
        #mugShelfDividerIconsContainer .mobile-divider-icon-small {
           display: flex; align-items: center; justify-content: center;
           width: 32px; height: 32px; padding: 0.2rem; background-color: rgba(243, 244, 246, 0.9);
           border: 1px solid #d1d5db; border-radius: 0.375rem; box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
           cursor: pointer; transition: all 0.15s ease-in-out; color: #4B5563;
        }
        #mugShelfDividerIconsContainer .mobile-divider-icon-small:hover { background-color: #e5e7eb; border-color: #9ca3af; color: #16A34A; }
        #mugShelfDividerIconsContainer .mobile-divider-icon-small.active-divider-icon { background-color: #16A34A; border-color: #15803d; color: #ffffff; box-shadow: inset 0 1px 2px rgba(0,0,0,0.1); }
        #mugShelfDividerIconsContainer .mobile-divider-icon-small svg { width: 1.1rem; height: 1.1rem; stroke-width: 1.75; }

        #mobileMugShelfMountStripsContainer { /* Kontener na paski monta≈ºu (pionowo) */
            display: flex; flex-direction: column; align-items: stretch; gap: 0.3rem; /* Pionowy uk≈Çad */
            margin-top: 0.4rem; padding-top: 0.4rem; border-top: 1px solid #e5e7eb;
        }
        .mount-strip-button { /* Styl pask√≥w tekstowych */
            font-size: 0.65rem; padding: 0.25rem 0.4rem; border-radius: 0.25rem;
            text-align: center; font-weight: 500; cursor: pointer;
            transition: background-color 0.15s ease-in-out, color 0.15s ease-in-out, border-color 0.15s ease-in-out;
            border: 1px solid transparent; line-height: 1.2;
        }
        .mount-strip-button.active-mount-strip { background-color: #16A34A; color: #ffffff; border-color: #15803d; }
        .mount-strip-button:not(.active-mount-strip) { background-color: #f3f4f6; color: #374151; border-color: #d1d5db; }
        .mount-strip-button:not(.active-mount-strip):hover { background-color: #e5e7eb; border-color: #9ca3af; }
        /* ---- Koniec styl√≥w dla Panelu ---- */

        /* Usuniƒôto styl dla #mobileDividerDimensionsInfo, poniewa≈º element jest usuwany */

        /* Styl dla informacji o wymiarach przegr√≥dki na desktopie */
        #desktopDividerDimensionsInfo { margin-top: 0.25rem; font-size: 0.75rem; color: #57534E; }

        /* NOWE STYLE DLA LIGHTBOXA I PASKA AKCJI W GALERII */
        /* Lightbox - wykorzystuje Tailwind, ale mo≈ºna dodaƒá wiƒôcej specyficznych styli tutaj */
        #imageLightbox.hidden { display: none; } /* Tailwind 'hidden' class robi to samo */

        /* Pasek akcji na zdjƒôciu w galerii */
        .image-actions-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 6px; /* Mniejszy padding dla kompaktowego wyglƒÖdu */
            background-color: rgba(0, 0, 0, 0.55); /* Nieco ciemniejsze t≈Ço dla lepszego kontrastu */
            display: flex;
            justify-content: space-evenly; /* R√≥wnomierne rozmieszczenie ikon */
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.25s ease-in-out;
            z-index: 10; /* Nad obrazkiem, pod ewentualnym hover effect na ca≈Çym kafelku */
            border-bottom-left-radius: 6px; /* Dopasowanie do zaokrƒÖglenia .gallery-image-container */
            border-bottom-right-radius: 6px;
        }

        .gallery-tile.actions-visible .image-actions-bar { /* Klasa dodawana na .gallery-tile */
            opacity: 1;
            pointer-events: auto;
        }

        .image-actions-bar .action-icon-btn {
            background: transparent;
            border: none;
            padding: 6px; /* Obszar klikalny */
            cursor: pointer;
            color: white; /* Kolor SVG */
            line-height: 0; /* Zapobiega dodatkowej przestrzeni, je≈õli SVG nie jest block */
            transition: transform 0.15s ease, color 0.15s ease;
        }
        .image-actions-bar .action-icon-btn:hover {
            color: #a7f3d0; /* Jasnozielony hover dla ikon (Tailwind green-200) */
            transform: scale(1.1);
        }
        .image-actions-bar .action-icon-btn svg {
            width: 22px; /* Rozmiar ikon */
            height: 22px;
            display: block;
        }
        /* Koniec nowych styl√≥w */

    </style>
</head>
<body class="flex flex-col justify-center items-center min-h-screen bg-stone-100 font-sans text-stone-800 pb-20 md:pb-0">

    <div id="imageLightbox" class="fixed inset-0 bg-black bg-opacity-85 flex items-center justify-center z-[1060] hidden p-4 transition-opacity duration-300 ease-in-out">
        <div class="relative">
            <img id="lightboxImage" src="" alt="Powiƒôkszone zdjƒôcie" class="max-w-[95vw] max-h-[90vh] object-contain rounded-md shadow-2xl">
            <button id="lightboxClose" aria-label="Zamknij powiƒôkszenie" class="absolute -top-2 -right-2 md:top-2 md:right-2 text-white bg-stone-800 bg-opacity-70 hover:bg-opacity-100 rounded-full p-1.5 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
    </div>
    <div id="orderDetailsModalOverlay" class="modal-overlay"> <div id="orderDetailsModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle"> <div class="modal-header"> <h3 id="modalTitle" class="modal-title">Szczeg√≥≈Çy Zam√≥wienia</h3> <button class="modal-close-button" aria-label="Zamknij">&times;</button> </div> <div class="modal-body"> <h4>Kod Zam√≥wienia:</h4> <p><strong id="modalOrderCode">≈Åadowanie...</strong></p> <h4>Podsumowanie:</h4> <p id="modalOrderSummary">Tutaj pojawiƒÖ siƒô szczeg√≥≈Çy zam√≥wienia po implementacji logiki...</p> </div> </div> </div>
    <div id="allegroOrderModalOverlay" class="modal-overlay"> <div id="allegroOrderModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="allegroModalTitle"> <div class="modal-header"> <h3 id="allegroModalTitle" class="modal-title">Potwierdzenie i Instrukcje</h3> <button id="allegroModalCloseButtonTop" class="modal-close-button" aria-label="Zamknij">&times;</button> </div> <div class="modal-body" id="allegroModalBody"> <p class="text-green-600 font-semibold text-center text-lg mb-3"> <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-2 -mt-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"> <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /> </svg> Kod zam√≥wienia zosta≈Ç skopiowany! </p> <div class="mb-4 p-3 bg-stone-100 rounded-md border border-stone-300"> <p class="text-sm text-stone-600 mb-1">Tw√≥j kod zam√≥wienia:</p> <p id="allegroModalOrderCode" class="font-mono text-lg font-bold text-stone-800 break-all select-all text-center"></p> </div> <div class="mb-4 p-3 bg-amber-50 rounded-md border border-amber-300"> <p class="text-sm text-stone-700">Cena p√≥≈Çki: <strong id="allegroModalPrice" class="text-red-600"></strong></p> </div> <h4 class="font-semibold text-stone-700 mb-2 mt-4 text-base">Co dalej?</h4> <p class="text-sm text-stone-600 mb-2"></p> <ol class="list-decimal text-sm text-stone-600 space-y-1 pl-5"> <li id="allegroModalInstructionUnits">Na stronie Allegro dodaj do koszyka tyle sztuk, ile wynosi cena Twojej p√≥≈Çki (wyliczona kwota).</li> <li>W zak≈Çadce Dostawa i p≈Çatno≈õƒá, w polu ‚ÄûUwagi do zakupu‚Äù, wklej kod zam√≥wienia.</li> <li>Z≈Ç√≥≈º i op≈Çaƒá zam√≥wienie ‚Äì a my zajmiemy siƒô resztƒÖ üòä</li> </ol> </div> <div class="modal-footer space-x-3"> <button id="allegroModalCloseButtonBottom" class="px-4 py-2 text-sm font-medium text-stone-700 bg-stone-200 hover:bg-stone-300 rounded-md">Zamknij</button> <button id="allegroModalGoButton" class="px-6 py-2 text-sm font-medium text-white bg-green-600 hover:bg-green-700 rounded-md shadow-sm hover:shadow-lg"> <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1.5 -ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"> <path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /> </svg> Przejd≈∫ do Allegro </button> </div> </div> </div>

    <div class="w-full max-w-7xl mx-auto px-4 md:px-6 my-6"> <details class="p-4 bg-emerald-50 border border-emerald-200 rounded-lg md:hidden group"> <summary class="flex justify-between items-center cursor-pointer list-none"> <h2 class="text-lg font-semibold text-emerald-800">Jak zam√≥wiƒá p√≥≈Çkƒô?</h2> <span class="marker transform transition-transform duration-200 rotate-0 group-open:rotate-180"> <svg class="w-5 h-5 text-emerald-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor"> <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" /> </svg> </span> </summary> <div class="mt-4 pt-4 border-t border-emerald-200"> <ul class="list-none instruction-list text-stone-700 space-y-3 text-sm"> <li><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 0 1 0 1.905c-.007.379.137.75.431.99l1.005.828c.428.355.53 1.005.26 1.43l-1.298 2.247a1.125 1.125 0 0 1-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 0 1-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.063-.374-.313-.686-.644-.87a6.52 6.52 0 0 1-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 0 1-1.369-.49l-1.297-2.247a1.125 1.125 0 0 1 .26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 0 1 0-1.905c.007-.379-.137-.75-.43-.99l-1.004-.828a1.125 1.125 0 0 1-.26-1.43l1.297-2.247a1.125 1.125 0 0 1 1.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /></svg> <span>Wybierz rodzaj p√≥≈Çki, wymiary, kolory i liczbƒô p√≥≈Çek.</span></li>
    <li><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg> <span>Sprawd≈∫ podsumowanie zam√≥wienia.</span></li>
    <li><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 4.25-3-3m0 0-3 3m3-3v12.75" /></svg> <span>Gdy wszystko ustawisz, strona poda cenƒô i kod zam√≥wienia.</span></li>
    <li><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 0 1 1.242 7.244l-4.5 4.5a4.5 4.5 0 0 1-6.364-6.364l1.757-1.757m13.35-.622 1.757-1.757a4.5 4.5 0 0 0-6.364-6.364l-4.5 4.5a4.5 4.5 0 0 0 1.242 7.244" /></svg> <span>Kliknij zielony przycisk, aby skopiowaƒá kod i przej≈õƒá na Allegro.</span></li>
    <li><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 3h1.386c.51 0 .955.343 1.087.835l.383 1.437M7.5 14.25a3 3 0 0 0-3 3h15.75m-12.75-3h11.218c1.121-2.3 2.1-4.684 2.924-7.138a60.114 60.114 0 0 0-16.536-1.84M7.5 14.25 5.106 5.272M6 20.25a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Zm12.75 0a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Z" /></svg> <span>Na Allegro zam√≥w dok≈Çadnie tyle sztuk, ile wynosi cena (np. 200 z≈Ç = 200 szt.).</span></li>
    <li><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" /></svg> <span>W polu ‚ÄûUwagi do zakupu‚Äù wklej skopiowany kod.</span></li>
    <li><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 8.25h19.5M2.25 9h19.5m-16.5 5.25h6m-6 2.25h3m-3.75 3h15a2.25 2.25 0 0 0 2.25-2.25V6.75A2.25 2.25 0 0 0 19.5 4.5h-15a2.25 2.25 0 0 0-2.25 2.25v10.5A2.25 2.25 0 0 0 4.5 19.5Z" /></svg> <span>Op≈Çaƒá zam√≥wienie ‚Äì my zajmiemy siƒô resztƒÖ! üòä</span></li>
</ul> </div> </details> </div>
<div id="tabbedGalleryContainer" class="w-full max-w-7xl mx-auto px-4 md:px-6"> <div class="gallery-tabs" id="galleryTabsContainer"></div> <div class="gallery-content-wrapper"> <button class="gallery-arrow gallery-prev-arrow" aria-label="Poprzednie zdjƒôcia">&#10094;</button> <div class="gallery-image-area" id="galleryImageArea"> <div class="gallery-grid" id="galleryGridContainer"></div> </div> <button class="gallery-arrow gallery-next-arrow" aria-label="Nastƒôpne zdjƒôcia">&#10095;</button> </div> </div>
<div id="configuratorSection" class="p-4 md:p-8 bg-white shadow-lg rounded-xl flex flex-col md:flex-row md:space-x-8 w-full max-w-7xl mx-auto mb-6">
        <div class="w-full md:w-1/3 space-y-8 mb-8 md:mb-0 order-1 md:order-1">
             <div id="shelfTypeSectionAnchor" class="p-6 shadow rounded-lg bg-white border border-stone-200 transition-shadow duration-200 hover:shadow-md"> <h2 class="text-lg font-semibold mb-4 flex items-center text-stone-800"> <svg class="h-6 w-6 mr-2 text-green-600 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"> <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 0 1 0 1.905c-.007.379.137.75.431.99l1.005.828c.428.355.53 1.005.26 1.43l-1.298 2.247a1.125 1.125 0 0 1-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 0 1-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.063-.374-.313-.686-.644-.87a6.52 6.52 0 0 1-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 0 1-1.369-.49l-1.297-2.247a1.125 1.125 0 0 1 .26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 0 1 0-1.905c.007-.379-.137-.75-.43-.99l-1.004-.828a1.125 1.125 0 0 1-.26-1.43l1.297-2.247a1.125 1.125 0 0 1 1.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281Z" /> <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /> </svg> Rodzaj p√≥≈Çki </h2> <select id="shelfType" class="custom-select w-full" onchange="handleShelfTypeChange();"> <option value="">-- Wybierz --</option> <option value="standing">StojƒÖca na blacie</option> <option value="hanging">WiszƒÖca</option> <option value="mug_shelf">P√≥≈Çka na kubki</option> </select> <div id="shelfTypeOptions" style="display:none; margin-top:1rem;" class="space-y-2"></div> <div id="mugShelfSpecificOptionsContainer" style="display:none;"> <div id="mugShelfMountOptions" class="mt-4 pt-4 border-t border-dashed border-stone-200"></div> <div id="mugShelfDividersOptions" class="mt-4 pt-4 border-t border-dashed border-stone-200"> <h3 class="text-md font-semibold mb-2 text-stone-700">Wstaw przegr√≥dki:</h3> <label class="flex items-center space-x-2"><input type="checkbox" id="dividersTop" class="rounded border-stone-300 text-green-600 shadow-sm focus:ring-green-500 focus:ring-offset-0 focus:ring-2" onchange="updatePreview(); updateOrderSummary();"><span>Na g√≥rze</span></label> <label class="flex items-center space-x-2 mt-1"><input type="checkbox" id="dividersMiddle" class="rounded border-stone-300 text-green-600 shadow-sm focus:ring-green-500 focus:ring-offset-0 focus:ring-2" onchange="updatePreview(); updateOrderSummary();"><span>Po≈õrodku</span></label> <label class="flex items-center space-x-2 mt-1"><input type="checkbox" id="dividersBottom" class="rounded border-stone-300 text-green-600 shadow-sm focus:ring-green-500 focus:ring-offset-0 focus:ring-2" onchange="updatePreview(); updateOrderSummary();"><span>Na dole</span></label> </div> </div> </div>
<div id="dimensionSectionAnchor" class="p-6 shadow rounded-lg bg-white border border-stone-200 transition-shadow duration-200 hover:shadow-md"> <h2 class="text-lg font-semibold mb-4 flex items-center text-stone-800"> <svg class="h-6 w-6 mr-2 text-green-600 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"> <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12h15m0 0l-6.75-6.75M19.5 12l-6.75 6.75" /> <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3.75v16.5M20.25 3.75v16.5" /> </svg> Wybierz wymiary </h2> <label class="block font-medium text-sm mb-1 text-stone-700">Szeroko≈õƒá:</label> <div id="widthSelectionArea"> <select id="width" class="custom-select w-full" onchange="checkCustomWidth();"> <option value="">-- Wybierz --</option> <option value="34">34 cm</option> <option value="44">44 cm</option> <option value="50">50 cm</option> <option value="60">60 cm</option> <option value="custom">Niestandardowa (35-59 cm)</option> </select> <div class="mt-2"> <input type="range" id="customWidthInput" min="35" max="59" step="1" value="35" style="display:none;" class="mt-2 cursor-pointer" oninput="let val = this.value; if (val === '50') { val = '49'; this.value = val; } document.getElementById('customWidthDisplay').textContent=val+' cm'; handleDimensionChange();"> <div class="flex justify-between items-center mt-1"> <span id="customWidthDisplay" style="display:none; font-weight:bold;" class="text-stone-700"></span> <small id="customWidthFee" style="display:none; font-size:.8rem; color:red;">dop≈Çata +50 z≈Ç</small> </div> </div> </div> <label id="heightLabel" class="block font-medium text-sm mt-4 mb-1 text-stone-700">Wysoko≈õƒá:</label> <select id="height" class="custom-select w-full" onchange="handleDimensionChange();"> <option value="">-- Wybierz --</option> <option value="40">40 cm</option> <option value="60">60 cm</option> <option value="80">80 cm</option> </select> <label id="depthLabel" class="block font-medium text-sm mt-4 mb-1 text-stone-700">G≈Çƒôboko≈õƒá:</label> <select id="depth" class="custom-select w-full" onchange="updatePreview(); updateOrderSummary();"> <option value="">-- Wybierz --</option> </select> </div>
             <div id="colorSectionAnchor" class="p-6 shadow rounded-lg bg-white border border-stone-200 transition-shadow duration-200 hover:shadow-md space-y-4"> <h2 class="text-lg font-semibold mb-4 flex items-center text-stone-800"> <svg class="h-6 w-6 mr-2 text-green-600 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"> <path stroke-linecap="round" stroke-linejoin="round" d="M9.53 16.122a3 3 0 00-5.78 1.128 2.25 2.25 0 01-2.4 2.245 4.5 4.5 0 008.4-2.245c0-.399-.078-.78-.22-1.128zm0 0a15.998 15.998 0 003.388-1.62m-5.043-.025a15.994 15.994 0 011.622-3.395m3.42 3.42a15.995 15.995 0 004.764-4.648l3.876-5.814a1.151 1.151 0 00-1.597-1.597L14.146 6.32a15.996 15.996 0 00-4.649 4.763m3.42 3.42a6.776 6.776 0 00-3.42-3.42" /> </svg> Wybierz kolor </h2> <div> <label for="sideColor" class="block font-medium text-sm mb-1 text-stone-700">Kolor bok√≥w:</label> <div class="flex items-center"> <select id="sideColor" class="custom-select flex-grow" onchange="updateOrderSummary(); updateSwatchDisplay('sideColor', 'sideColorSwatchDisplay');"> <option value="">-- Wybierz --</option> <option value="#8B5A2B" data-color="#8B5A2B">DƒÖb Craft Z≈Çoty</option> <option value="#FFFFFF" data-color="#FFFFFF">Bia≈Çy matowy</option> <option value="#000000" data-color="#000000">Czarny matowy</option> </select> <span id="sideColorSwatchDisplay" class="color-swatch-display"></span> </div> </div> <div class="pt-2"> <label id="shelfColorLabel" for="shelfColor" class="block font-medium text-sm mb-1 text-stone-700">Kolor p√≥≈Çek i podstaw:</label> <div class="flex items-center"> <select id="shelfColor" class="custom-select flex-grow" onchange="updateOrderSummary(); updateSwatchDisplay('shelfColor', 'shelfColorSwatchDisplay');"> <option value="">-- Wybierz --</option> <option value="#8B5A2B" data-color="#8B5A2B">DƒÖb Craft Z≈Çoty</option> <option value="#FFFFFF" data-color="#FFFFFF">Bia≈Çy matowy</option> <option value="#000000" data-color="#000000">Czarny matowy</option> </select> <span id="shelfColorSwatchDisplay" class="color-swatch-display"></span> </div> </div> <details class="color-samples-details" id="materialSamplesDetails"> <summary> <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 mr-2 text-stone-600" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5C7.305 4.5 3.135 7.515 1.5 12c1.635 4.485 5.805 7.5 10.5 7.5s8.865-3.015 10.5-7.5C20.865 7.515 16.695 4.5 12 4.5z" /><path stroke-linecap="round" stroke-linejoin="round" d="M12 9a3 3 0 100 6 3 3 0 000-6z" /></svg> <span>Zobacz pr√≥bki kolor√≥w</span> <svg class="w-4 h-4 summary-chevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" /></svg> </summary> <div id="materialSwiper" class="swiper"> <div class="swiper-wrapper"> <div class="swiper-slide"> <img src="img/dabduze.jpg" alt="DƒÖb Craft Z≈Çoty"> <div class="material-name">DƒÖb Craft Z≈Çoty - struktura drewna</div> </div> <div class="swiper-slide"> <img src="img/bialyduze.jpg" alt="Bia≈Çy matowy"> <div class="material-name">Bia≈Çy matowy - g≈Çadki</div> </div> <div class="swiper-slide"> <img src="img/czarnyduze.jpg" alt="Czarny matowy"> <div class="material-name">Czarny matowy - g≈Çadki</div> </div> </div> <div class="material-swiper-button-prev swiper-button-prev"></div> <div class="material-swiper-button-next swiper-button-next"></div> </div> </details> </div>
        </div> <div class="w-full md:w-2/3 flex flex-col items-center mb-8 md:mb-0 order-2 md:order-2">
             <div id="shelfContainer" class="mx-auto relative"> <button id="collapse3dPanelButton" onclick="close3dPanel()" title="Zwi≈Ñ podglƒÖd 3D" class="z-20"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"> <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" /> </svg> <span class="sr-only">Zwi≈Ñ podglƒÖd 3D</span> </button>
                  <div id="mobilePanelIcons" class="hidden md:hidden"> <button onclick="scrollToElementAndHighlight('shelfTypeSectionAnchor', 'start', this);" title="Przewi≈Ñ do rodzaju p√≥≈Çki"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"> <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 0 1 0 1.905c-.007.379.137.75.431.99l1.005.828c.428.355.53 1.005.26 1.43l-1.298 2.247a1.125 1.125 0 0 1-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 0 1-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.063-.374-.313-.686-.644-.87a6.52 6.52 0 0 1-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 0 1-1.369-.49l-1.297-2.247a1.125 1.125 0 0 1 .26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 0 1 0-1.905c.007-.379-.137-.75-.43-.99l-1.004-.828a1.125 1.125 0 0 1-.26-1.43l1.297-2.247a1.125 1.125 0 0 1 1.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281Z" /> <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /> </svg> <span>Rodzaj</span> </button> <button onclick="scrollToElementAndHighlight('dimensionSectionAnchor', 'start', this);" title="Przewi≈Ñ do wymiar√≥w"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"> <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12h15m0 0l-6.75-6.75M19.5 12l-6.75 6.75" /> <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3.75v16.5M20.25 3.75v16.5" /> </svg> <span>Wymiary</span> </button> <button onclick="scrollToElementAndHighlight('colorSectionAnchor', 'start', this);" title="Przewi≈Ñ do kolor√≥w"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"> <path stroke-linecap="round" stroke-linejoin="round" d="M9.53 16.122a3 3 0 00-5.78 1.128 2.25 2.25 0 01-2.4 2.245 4.5 4.5 0 008.4-2.245c0-.399-.078-.78-.22-1.128zm0 0a15.998 15.998 0 003.388-1.62m-5.043-.025a15.994 15.994 0 011.622-3.395m3.42 3.42a15.995 15.995 0 004.764-4.648l3.876-5.814a1.151 1.151 0 00-1.597-1.597L14.146 6.32a15.996 15.996 0 00-4.649 4.763m3.42 3.42a6.776 6.776 0 00-3.42-3.42" /> </svg> <span>Kolory</span> </button> <button onclick="scrollToElementAndHighlight('shelfCountSection', 'start', this);" title="Przewi≈Ñ do dodawania p√≥≈Çek">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
        <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 9h16.5M3.75 15h16.5" />
    </svg>
    <span>P√≥≈Çki</span>
</button> </div>
                  <div id="mugShelfDividerIconsContainer" class="z-10"> <p class="mug-shelf-controls-header">przegr√≥dki</p> <div id="dividerIconGroup"> <button id="addTopDividerBtn" data-divider-type="top" title="Dodaj/Usu≈Ñ g√≥rnƒÖ przegr√≥dkƒô" class="mobile-divider-icon-small"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"> <path stroke-linecap="round" stroke-linejoin="round" d="M4 4h16v16H4V4zm0 6h16" /> </svg> </button> <button id="addMiddleDividerBtn" data-divider-type="middle" title="Dodaj/Usu≈Ñ ≈õrodkowƒÖ przegr√≥dkƒô" class="mobile-divider-icon-small"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"> <path stroke-linecap="round" stroke-linejoin="round" d="M4 4h16v16H4V4zm0 8h16" /> </svg> </button> <button id="addBottomDividerBtn" data-divider-type="bottom" title="Dodaj/Usu≈Ñ dolnƒÖ przegr√≥dkƒô" class="mobile-divider-icon-small"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"> <path stroke-linecap="round" stroke-linejoin="round" d="M4 4h16v16H4V4zm0 10h16" /> </svg> </button> </div> <div id="mobileMugShelfMountStripsContainer"> <button id="mobileMountHangingStripBtn" class="mount-strip-button">wiszƒÖca</button> <button id="mobileMountStandingStripBtn" class="mount-strip-button">stojƒÖca</button> </div> </div>
                  <div id="threeJsCanvasWrapper" class="flex-grow"> </div>
                  </div> <div class="text-sm text-stone-600 italic mt-2 text-center md:hidden"></div>
             <div class="text-sm text-stone-600 italic mt-2 text-center hidden md:block"> Obr√≥ƒá lub zbli≈º model (przeciƒÖgnij myszkƒÖ) </div>
             <div id="shelfCountSection" class="p-6 shadow rounded-lg bg-white border border-stone-200 transition-shadow duration-200 hover:shadow-md mt-0,1 md:mt-8 w-full max-w-lg"> <h2 class="text-lg font-semibold mb-4 flex items-center text-stone-800"> <svg class="h-6 w-6 mr-2 text-green-600 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"> <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /> <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 9h16.5M3.75 15h16.5" /> </svg> Dodaj p√≥≈Çki wewnƒôtrzne </h2> <select id="shelfCount" class="custom-select w-full" onchange="updatePreview(); updateOrderSummary();"> <option value="">-- Wybierz --</option> </select> <p id="gapDisplay" class="mt-3 text-sm text-stone-700 font-medium">Odleg≈Ço≈õƒá miƒôdzy p√≥≈Çkami: <span id="gapSummaryDisplay" class="font-bold text-stone-900"></span></p> <div id="desktopDividerDimensionsInfo" style="display: none;"> Wymiar przegr√≥dki: szer. 12,5cm, wys. 10,9cm </div> </div>
             <details class="bg-emerald-50 border border-emerald-200 rounded-lg mt-8 w-full max-w-lg hidden md:block transition-shadow duration-200 hover:shadow-md overflow-hidden group"> <summary class="p-6 flex justify-between items-center cursor-pointer list-none hover:bg-emerald-100 transition-colors duration-150"> <h2 class="text-xl font-semibold text-emerald-800">Jak zam√≥wiƒá p√≥≈Çkƒô?</h2> <span class="marker transform transition-transform duration-200 rotate-0 group-open:rotate-180"> <svg class="w-5 h-5 text-emerald-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor"> <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" /> </svg> </span> </summary> <div class="p-6 pt-2 border-t border-emerald-200">
<ul class="list-none instruction-list text-stone-700 space-y-3 text-sm md:text-base">
                          <li><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 0 1 0 1.905c-.007.379.137.75.431.99l1.005.828c.428.355.53 1.005.26 1.43l-1.298 2.247a1.125 1.125 0 0 1-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 0 1-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.063-.374-.313-.686-.644-.87a6.52 6.52 0 0 1-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 0 1-1.369-.49l-1.297-2.247a1.125 1.125 0 0 1 .26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 0 1 0-1.905c.007-.379-.137-.75-.43-.99l-1.004-.828a1.125 1.125 0 0 1-.26-1.43l1.297-2.247a1.125 1.125 0 0 1 1.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /></svg> <span>Wybierz rodzaj p√≥≈Çki, wymiary, kolory i liczbƒô p√≥≈Çek.</span></li>
                           <li><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 4.25-3-3m0 0-3 3m3-3v12.75" /></svg> <span>Gdy wszystko ustawisz, strona poda cenƒô i kod zam√≥wienia.</span></li>
                           <li><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 0 1 1.242 7.244l-4.5 4.5a4.5 4.5 0 0 1-6.364-6.364l1.757-1.757m13.35-.622 1.757-1.757a4.5 4.5 0 0 0-6.364-6.364l-4.5 4.5a4.5 4.5 0 0 0 1.242 7.244" /></svg> <span>Kliknij zielony przycisk, aby skopiowaƒá kod i przej≈õƒá na Allegro.</span></li>
                           <li><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 3h1.386c.51 0 .955.343 1.087.835l.383 1.437M7.5 14.25a3 3 0 0 0-3 3h15.75m-12.75-3h11.218c1.121-2.3 2.1-4.684 2.924-7.138a60.114 60.114 0 0 0-16.536-1.84M7.5 14.25 5.106 5.272M6 20.25a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Zm12.75 0a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Z" /></svg> <span>Na Allegro zam√≥w dok≈Çadnie tyle sztuk, ile wynosi cena (np. 200 z≈Ç = 200 szt.).</span></li>
                           <li><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" /></svg> <span>W polu ‚ÄûUwagi do zakupu‚Äù wklej skopiowany kod.</span></li>
                           <li><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 8.25h19.5M2.25 9h19.5m-16.5 5.25h6m-6 2.25h3m-3.75 3h15a2.25 2.25 0 0 0 2.25-2.25V6.75A2.25 2.25 0 0 0 19.5 4.5h-15a2.25 2.25 0 0 0-2.25 2.25v10.5A2.25 2.25 0 0 0 4.5 19.5Z" /></svg> <span>Op≈Çaƒá zam√≥wienie ‚Äì my zajmiemy siƒô resztƒÖ! üòä</span></li>
                       </ul>
                   </div>
              </details> <div class="mt-8 bg-white p-6 rounded-lg shadow-md text-center border border-stone-200 transition-shadow duration-200 hover:shadow-lg w-full max-w-lg">
                   <h3 class="text-stone-700 font-semibold mb-3 text-base">Co m√≥wiƒÖ nasi klienci?</h3>
                   <div id="customerReview" class="text-stone-600 text-base italic review-fade-enter flex items-center justify-center space-x-2 min-h-[4em]"></div>
               </div>
            </div> <div class="w-full md:w-1/3 p-6 bg-stone-50 border border-stone-200 rounded-lg space-y-6 order-3 md:order-3">
             <div class="order-summary bg-white shadow-lg rounded-lg p-6 transition-shadow duration-200 hover:shadow-xl">
                <h2 class="text-xl font-semibold mb-4 text-stone-800">Podsumowanie Zam√≥wienia</h2>
                <ul class="divide-y divide-stone-200 text-sm">
                    <li class="py-2 flex justify-between items-center"><span class="font-medium text-stone-600">Rodzaj p√≥≈Çki:</span><span id="shelfTypeSummary" class="text-stone-900 text-right">nie wybrano</span></li>
                    <li id="mugShelfMountSummaryItem" class="py-2 flex justify-between items-center" style="display: none;"><span class="font-medium text-stone-600">Monta≈º:</span><span id="mugShelfMountSummary" class="text-stone-900 text-right"></span></li>
                    <li class="py-2 flex justify-between items-center"><span class="font-medium text-stone-600">Szeroko≈õƒá:</span><span id="widthSummary" class="text-stone-900"></span></li>
                    <li class="py-2 flex justify-between items-center"><span class="font-medium text-stone-600">Wysoko≈õƒá:</span><span id="heightSummary" class="text-stone-900"></span></li>
                    <li class="py-2 flex justify-between items-center"><span class="font-medium text-stone-600">G≈Çƒôboko≈õƒá:</span><span id="depthSummary" class="text-stone-900"></span></li>
                    <li class="py-2 flex justify-between items-center"><span class="font-medium text-stone-600">Kolor bok√≥w:</span><span id="sideColorSummary" class="text-stone-900 text-right">nie wybrano</span></li>
                    <li class="py-2 flex justify-between items-center"><span id="shelfColorSummaryLabel" class="font-medium text-stone-600">Kolor p√≥≈Çek i podstaw:</span><span id="shelfColorSummary" class="text-stone-900 text-right">nie wybrano</span></li>
                    <li class="py-2 flex justify-between items-center"><span class="font-medium text-stone-600">Ilo≈õƒá p√≥≈Çek wewn.:</span><span id="shelfCountSummary" class="text-stone-900"></span></li>
                    <li class="py-2 flex justify-between items-center"><span class="font-medium text-stone-600">Odleg≈Ço≈õƒá miƒôdzy p√≥≈Çkami:</span><span id="gapSummary" class="text-stone-900"></span></li>
                    <li class="py-2 flex justify-between items-center"><span class="font-medium text-stone-600">Opcje dodatkowe:</span><span id="extraOptionsSummary" class="text-stone-900 text-right">standardowa</span></li>
                    <li class="pt-2 pb-1 flex justify-between items-center"><span class="font-medium text-stone-600">Materia≈Ç:</span><span class="text-stone-900 text-right">p≈Çyta laminowana gr. 1,8 cm</span></li>
                    <li class="pt-1 pb-2 flex justify-between items-center"><span class="font-medium text-stone-600">Termin realizacji:</span><span class="text-stone-900 text-right">5‚Äë7 dni roboczych</span></li>
                </ul>

                <div class="mt-5 pt-4 border-t border-stone-200" id="finalOrderSummary">
                    <div class="group bg-stone-100 border border-stone-200 rounded-lg p-4 mb-4 transition-shadow hover:shadow-sm">
                         <div class="flex justify-between items-center mb-2"> <span class="flex items-center text-base font-medium text-stone-700"> <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-stone-500 transition-transform duration-200 ease-in-out group-hover:translate-x-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"> <path stroke-linecap="round" stroke-linejoin="round" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" /> </svg> Cena: </span> <span class="text-red-600 font-bold text-2xl" id="priceSummary"></span> </div>
                         <p id="priceHint" class="text-stone-500 text-xs mt-2 text-center">Wybierz wszystkie parametry, aby zobaczyƒá cenƒô.</p>
                    </div>

                     <div id="orderActionsWrapper" style="display:none;" class="mt-4 flex flex-col space-y-3">
                          <button id="downloadOrderButton" onclick="downloadOrderSummary()" class="group w-full inline-flex items-center justify-center space-x-2 px-4 py-2 border border-stone-300 rounded-md shadow-sm text-sm font-medium text-stone-700 bg-stone-100 hover:bg-stone-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 cursor-pointer transition-all duration-150 ease-in-out active:scale-95 hover:shadow-md"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 transition-transform duration-150 ease-in-out group-hover:animate-pulse"> <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" /> </svg> <span>Zapisz podsumowanie</span> </button>
                          <div id="orderCodeWindow" class="group w-full p-3 border border-stone-200 rounded-md bg-stone-50 text-center transition-opacity duration-300 ease-in-out"> <span class="flex items-center justify-center text-xs text-stone-500 uppercase mb-1 tracking-wide"> <svg id="orderCodeIcon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-stone-400 transition-transform duration-200 ease-in-out group-hover:translate-x-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"> <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" /> </svg> Kod zam√≥wienia </span> <code id="orderCodeVisible" class="block font-mono text-sm md:text-base font-bold text-stone-800 break-all select-all" style="line-height: 1.2;"></code> </div>
                          <button onclick="copyOrderSummary()" class="group w-full px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg text-lg font-semibold transition-all duration-150 ease-in-out flex items-center justify-center space-x-2 shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 active:scale-95"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 transition-transform duration-150 ease-in-out group-hover:animate-bounce"> <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 3h1.386c.51 0 .955.343 1.087.835l.383 1.437M7.5 14.25a3 3 0 0 0-3 3h15.75m-12.75-3h11.218c1.121-2.3 2.1-4.684 2.924-7.138a60.114 60.114 0 0 0-16.536-1.84M7.5 14.25 5.106 5.272M6 20.25a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Zm12.75 0a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Z" /> </svg> <span>Zam√≥w na Allegro</span> </button>
                     </div>
                     <div id="viewOrderSection" class="mt-6 pt-4 border-t border-dashed border-stone-300">
                         <label for="viewOrderCodeInput">Masz kod zam√≥wienia?</label>
                         <input type="text" id="viewOrderCodeInput" class="text-base" placeholder="Wklej kod tutaj, aby zobaczyƒá szczeg√≥≈Çy...">
                         </div>
                     </div>
            </div> </div> </div>
<script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script>
<script>
// --- Zmienne globalne i elementy DOM ---
        let scene, camera, renderer, shelfGroup, controls;
        let shelfContainer, threeJsCanvasWrapper, materialSwiperInstance;
        let shelfTypeSelect, widthSelect, heightSelect, depthSelect, shelfCountSelect;
        let customWidthInput, customWidthDisplay, customWidthFee;
        let shelfTypeOptionsDiv, widthSelectionArea, dimensionSectionAnchor, colorSectionAnchor, shelfTypeSectionAnchor;
        let heightLabel, depthLabel, sideColorSelect, shelfColorSelect;
        let mugShelfSpecificOptionsContainer, mugShelfMountOptionsDiv, mugShelfDividersOptionsDiv;
        let dividersTopCheckbox, dividersMiddleCheckbox, dividersBottomCheckbox;
        let configuratorSection, shelfCountSection;
        let galleryTabsContainer, galleryGridContainer, galleryImageArea, galleryPrevArrow, galleryNextArrow;
        let show3dButton, collapse3dPanelButton;
        let footerPriceTextElement, selectionCompleteIndicator;
        let autoRotateEnabled = true;
        const initialCameraPosition = { x: 4, y: 5, z: 7 };

        // Zmienne dla panelu mobilnego 3D
        let mugShelfDividerIconsContainer, addTopDividerBtn, addMiddleDividerBtn, addBottomDividerBtn;
        let mobileMugShelfMountStripsContainer, mobileMountHangingStripBtn, mobileMountStandingStripBtn;

        // Zmienne dla informacji o wymiarach przegr√≥dek (tylko desktop)
        let desktopDividerDimensionsInfo;

        // Zmienne dla modali
        let viewOrderCodeInput, orderDetailsModalOverlay, orderDetailsModal, modalCloseButton, modalOrderCodeSpan, modalOrderSummaryP;
        let allegroOrderModalOverlay, allegroModalOrderCodeEl, allegroModalPriceEl, allegroModalUnitsInstructionEl, allegroModalGoButton, allegroModalCloseButtonTop, allegroModalCloseButtonBottom;

        // NOWE ZMIENNE DLA LIGHTBOXA
        let imageLightbox, lightboxImage, lightboxCloseBtn;


        // --- Predefined Shelf Configurations ---
        const wiszace_configs = [
            { type: 'hanging', sideColor: '#8B5A2B', shelfColor: '#8B5A2B', height: '80', width: '44', depth: '10', shelfCount: '5' }, // 1
            { type: 'hanging', sideColor: '#FFFFFF', shelfColor: '#FFFFFF', height: '80', width: '44', depth: '10', shelfCount: '5' }, // 2
            { type: 'hanging', sideColor: '#8B5A2B', shelfColor: '#FFFFFF', height: '80', width: '44', depth: '10', shelfCount: '5' }, // 3
            { type: 'hanging', sideColor: '#000000', shelfColor: '#8B5A2B', height: '80', width: '44', depth: '10', shelfCount: '5' }, // 4
            { type: 'hanging', sideColor: '#000000', shelfColor: '#000000', height: '80', width: '44', depth: '10', shelfCount: '5' }, // 5
            { type: 'hanging', sideColor: '#8B5A2B', shelfColor: '#8B5A2B', height: '40', width: '60', depth: '10', shelfCount: '2' }, // 6
            { type: 'hanging', sideColor: '#FFFFFF', shelfColor: '#FFFFFF', height: '40', width: '60', depth: '10', shelfCount: '2' }, // 7
            { type: 'hanging', sideColor: '#000000', shelfColor: '#8B5A2B', height: '40', width: '60', depth: '10', shelfCount: '2' }, // 8
            { type: 'hanging', sideColor: '#000000', shelfColor: '#000000', height: '40', width: '60', depth: '10', shelfCount: '2' }, // 9
            { type: 'hanging', sideColor: '#8B5A2B', shelfColor: '#FFFFFF', height: '40', width: '60', depth: '10', shelfCount: '2' }, // 10
            { type: 'hanging', sideColor: '#FFFFFF', shelfColor: '#FFFFFF', height: '60', width: '44', depth: '10', shelfCount: '3', noTopShelf: true }, // 11
            { type: 'hanging', sideColor: '#000000', shelfColor: '#8B5A2B', height: '60', width: '44', depth: '10', shelfCount: '3', noTopShelf: true }, // 12
            { type: 'hanging', sideColor: '#FFFFFF', shelfColor: '#8B5A2B', height: '60', width: '44', depth: '10', shelfCount: '3', noTopShelf: true }, // 13
            { type: 'hanging', sideColor: '#000000', shelfColor: '#000000', height: '60', width: '44', depth: '10', shelfCount: '3', noTopShelf: true }, // 14
            { type: 'hanging', sideColor: '#FFFFFF', shelfColor: '#8B5A2B', height: '40', width: '44', depth: '10', shelfCount: '2', noTopShelf: true }  // 15
        ];

        const stojace_configs = [
            { type: 'standing', sideColor: '#8B5A2B', shelfColor: '#8B5A2B', height: '40', width: '60', depth: '10', shelfCount: '2' }, // 1
            { type: 'standing', sideColor: '#FFFFFF', shelfColor: '#8B5A2B', height: '40', width: '60', depth: '10', shelfCount: '2' }, // 2
            { type: 'standing', sideColor: '#000000', shelfColor: '#8B5A2B', height: '40', width: '60', depth: '10', shelfCount: '2' }, // 3
            { type: 'standing', sideColor: '#FFFFFF', shelfColor: '#FFFFFF', height: '40', width: '60', depth: '10', shelfCount: '2' }, // 4
            { type: 'standing', sideColor: '#000000', shelfColor: '#000000', height: '40', width: '60', depth: '10', shelfCount: '2' }, // 5
            { type: 'standing', sideColor: '#8B5A2B', shelfColor: '#8B5A2B', height: '40', width: '60', depth: '10', shelfCount: '2', noBottomShelf: true }, // 6
            { type: 'standing', sideColor: '#8B5A2B', shelfColor: '#FFFFFF', height: '40', width: '60', depth: '10', shelfCount: '2', noBottomShelf: true }, // 7
            { type: 'standing', sideColor: '#8B5A2B', shelfColor: '#8B5A2B', height: '40', width: '60', depth: '15', shelfCount: '2', noBottomShelf: true, noTopShelf: true }, // 8
            { type: 'standing', sideColor: '#000000', shelfColor: '#8B5A2B', height: '40', width: '60', depth: '15', shelfCount: '2', noBottomShelf: true, noTopShelf: true }, // 9
            { type: 'standing', sideColor: '#8B5A2B', shelfColor: '#8B5A2B', height: '40', width: '60', depth: '10', shelfCount: '2', noBottomShelf: true, noTopShelf: true }, // 10
            { type: 'standing', sideColor: '#000000', shelfColor: '#8B5A2B', height: '40', width: '44', depth: '10', shelfCount: '2', noBottomShelf: true, noTopShelf: true }  // 11
        ];

        const kubki_configs = [
    { type: 'mug_shelf', mount: 'standing', sideColor: '#8B5A2B', shelfColor: '#8B5A2B', height: '40', width: '44', depth: '10', dividers: { top: true, middle: true, bottom: true } }, // 1
    { type: 'mug_shelf', mount: 'standing', sideColor: '#000000', shelfColor: '#8B5A2B', height: '40', width: '44', depth: '10', dividers: { top: true, middle: true, bottom: true } }, // 2
    { type: 'mug_shelf', mount: 'standing', sideColor: '#8B5A2B', shelfColor: '#8B5A2B', height: '40', width: '60', depth: '10', dividers: { top: true, middle: true, bottom: true } }, // 3
    { type: 'mug_shelf', mount: 'standing', sideColor: '#8B5A2B', shelfColor: '#FFFFFF', height: '40', width: '60', depth: '10', dividers: { top: true, middle: true, bottom: true } }, // 4
    { type: 'mug_shelf', mount: 'standing', sideColor: '#8B5A2B', shelfColor: '#000000', height: '40', width: '60', depth: '10', dividers: { top: true, middle: true, bottom: true } }, // 5
    { type: 'mug_shelf', mount: 'standing', sideColor: '#8B5A2B', shelfColor: '#8B5A2B', height: '40', width: '44', depth: '10', dividers: { top: true, middle: true, bottom: true } }, // 6
    { type: 'mug_shelf', mount: 'standing', sideColor: '#8B5A2B', shelfColor: '#8B5A2B', height: '40', width: '60', depth: '10', dividers: { top: true, middle: false, bottom: false } }, // 7
    { type: 'mug_shelf', mount: 'standing', sideColor: '#8B5A2B', shelfColor: '#000000', height: '40', width: '60', depth: '10', dividers: { top: true, middle: false, bottom: true } }, // 8
    { type: 'mug_shelf', mount: 'standing', sideColor: '#8B5A2B', shelfColor: '#FFFFFF', height: '40', width: '60', depth: '10', dividers: { top: true, middle: false, bottom: true } }, // 9
    { type: 'mug_shelf', mount: 'hanging', sideColor: '#8B5A2B', shelfColor: '#8B5A2B', height: '40', width: '60', depth: '10', dividers: { top: true, middle: true, bottom: true } }, // 10
    { type: 'mug_shelf', mount: 'hanging', sideColor: '#8B5A2B', shelfColor: '#FFFFFF', height: '40', width: '60', depth: '10', dividers: { top: true, middle: true, bottom: true } }, // 11
    { type: 'mug_shelf', mount: 'hanging', sideColor: '#8B5A2B', shelfColor: '#000000', height: '40', width: '60', depth: '10', dividers: { top: true, middle: true, bottom: true } }, // 12
    { type: 'mug_shelf', mount: 'standing', sideColor: '#8B5A2B', shelfColor: '#8B5A2B', height: '60', width: '44', depth: '10', dividers: { top: true, middle: true, bottom: true } }, // 13
    { type: 'mug_shelf', mount: 'standing', sideColor: '#8B5A2B', shelfColor: '#8B5A2B', height: '60', width: '44', depth: '10', dividers: { top: true, middle: true, bottom: true } },  // 14
    {
        type: 'mug_shelf',
        mount: 'standing',
        sideColor: '#8B5A2B',
        shelfColor: '#8B5A2B',
        height: '40',
        width: '84',
        depth: '10',
        dividers: { top: true, middle: true, bottom: true }
    } // 15b
];
        const predefinedShelfConfigurations = [ wiszace_configs, stojace_configs, kubki_configs ];

        // --- Function to Apply Shelf Configuration from Gallery ---
        function applyShelfConfigurationFromGallery(galleryIndex, imageIndex) {
            const config = predefinedShelfConfigurations[galleryIndex]?.[imageIndex];
            if (!config) {
                console.error('Configuration not found for galleryIndex:', galleryIndex, 'imageIndex:', imageIndex);
                alert('Wybrana konfiguracja jest niedostƒôpna. Proszƒô wybraƒá innƒÖ lub skonfigurowaƒá rƒôcznie.');
                return;
            }
            shelfTypeSelect.value = config.type;
            handleShelfTypeChange(true);
            if (config.type === 'mug_shelf') {
                if (Array.from(widthSelect.options).some(opt => opt.value === String(config.width))) {
                    widthSelect.value = String(config.width);
                } else if (widthSelect.options.length > 0) {
                    widthSelect.value = widthSelect.options[0].value;
                }
                if (Array.from(heightSelect.options).some(opt => opt.value === String(config.height))) {
                     heightSelect.value = String(config.height);
                } else if (heightSelect.options.length > 0) {
                     heightSelect.value = heightSelect.options[0].value;
                }
                handleMugShelfHeightChange();
                handleMugShelfWidthChange();
            } else {
                const widthValueString = String(config.width);
                const widthOptionExists = Array.from(widthSelect.options).some(opt => opt.value === widthValueString);
                if (widthOptionExists) {
                    widthSelect.value = widthValueString;
                } else if (parseInt(widthValueString) >= 35 && parseInt(widthValueString) <= 59 && Array.from(widthSelect.options).some(opt => opt.value === 'custom')) {
                    widthSelect.value = 'custom';
                }
                checkCustomWidth();
                if (widthSelect.value === 'custom' && customWidthInput && parseInt(widthValueString) >= 35 && parseInt(widthValueString) <= 59) {
                     customWidthInput.value = widthValueString;
                     if(customWidthDisplay) customWidthDisplay.textContent = widthValueString + ' cm';
                }
                heightSelect.value = config.height;
                handleDimensionChange();
                if (Array.from(depthSelect.options).some(opt => opt.value === String(config.depth))) {
                    depthSelect.value = String(config.depth);
                } else {
                     console.warn(`Depth ${config.depth} not available for current selections. Clearing or defaulting.`);
                     if(depthSelect.options.length > 0) depthSelect.value = depthSelect.options[0].value;
                }
                if (Array.from(shelfCountSelect.options).some(opt => opt.value === String(config.shelfCount))) {
                    shelfCountSelect.value = String(config.shelfCount);
                } else {
                    console.warn(`Shelf count ${config.shelfCount} not available for height ${config.height}. Defaulting or clearing.`);
                    if (shelfCountSelect.options.length > 0) shelfCountSelect.value = shelfCountSelect.options[0].value;
                }
            }
            sideColorSelect.value = config.sideColor;
            shelfColorSelect.value = config.shelfColor;
            updateSwatchDisplay('sideColor', 'sideColorSwatchDisplay');
            updateSwatchDisplay('shelfColor', 'shelfColorSwatchDisplay');
            if (config.type === 'hanging' || config.type === 'standing') {
                const noTopShelfCheckboxElem = document.getElementById('noTopShelf');
                if (noTopShelfCheckboxElem) noTopShelfCheckboxElem.checked = !!config.noTopShelf;
                if (config.type === 'standing') {
                    const noBottomShelfCheckboxElem = document.getElementById('noBottomShelf');
                    if (noBottomShelfCheckboxElem) noBottomShelfCheckboxElem.checked = !!config.noBottomShelf;
                }
            } else if (config.type === 'mug_shelf') {
                const mountRadio = document.querySelector(`input[name="mugShelfMount"][value="${config.mount}"]`);
                if (mountRadio) mountRadio.checked = true;
                if (dividersTopCheckbox) dividersTopCheckbox.checked = !!config.dividers?.top;
                if (dividersMiddleCheckbox) dividersMiddleCheckbox.checked = !!config.dividers?.middle;
                if (dividersBottomCheckbox) dividersBottomCheckbox.checked = !!config.dividers?.bottom;
                updateDividerIconActiveStates();
                if (typeof updateMobileMountStripStates === "function") updateMobileMountStripStates();
            }
            updatePreview();
            updateOrderSummary();
        }

        const originalPreviewMaterialParams = { color: 0x777777, metalness: 0, roughness: 0.6 };
        let originalWidthOptions = [];
        let originalHeightOptions = [];
        const pricing = {"34":{"40":{"10":{"2":150},"15":{"2":250}},"60":{"10":{"2":175,"3":200},"15":{"2":275,"3":300}},"80":{"10":{"2":200,"3":225,"4":250,"5":279},"15":{"2":300,"3":325,"4":350,"5":379}}},"44":{"40":{"10":{"2":169},"15":{"2":269}},"60":{"10":{"2":179,"3":189},"15":{"2":279,"3":289}},"80":{"10":{"2":200,"3":250,"4":275,"5":299},"15":{"2":300,"3":350,"4":375,"5":399}}},"50":{"40":{"10":{"2":179},"15":{"2":279}},"60":{"10":{"2":189,"3":199},"15":{"2":289,"3":299}},"80":{"10":{"2":250,"3":250,"4":300,"5":329},"15":{}}},"60":{"40":{"10":{"2":179},"15":{"2":279}},"60":{"10":{"2":209,"3":219},"15":{"2":309,"3":319}},"80":{"10":{"2":250,"3":275,"4":325,"5":319},"15":{}}}};
        const mugShelfPricing = {
            "44": { "40": 169, "60": 189 },
            "60": { "40": 179, "60": 219 },
            "84": { "40": 299 }
        };
        const galleryData = [
    {
        title: 'P√≥≈Çki wiszƒÖce',
        imgs: ['img/1.jpg', 'img/2.jpg', 'img/3.jpg', 'img/4.jpg', 'img/5.jpg', 'img/6.jpg', 'img/7.jpg', 'img/8.jpg', 'img/9.jpg', 'img/10.jpg', 'img/11.jpg', 'img/12.jpg', 'img/13.jpg', 'img/14.jpg', 'img/15.jpg']
    },
    {
        title: 'P√≥≈Çki stojƒÖce',
        imgs: ['img/1a.jpg', 'img/2a.jpg', 'img/3a.jpg', 'img/4a.jpg', 'img/5a.jpg', 'img/6a.jpg', 'img/7a.jpg', 'img/8a.jpg', 'img/9a.jpg', 'img/10a.jpg', 'img/11a.jpg']
    },
    {
        title: 'P√≥≈Çki na kubki',
        imgs: ['img/1b.jpg', 'img/2b.jpg', 'img/3b.jpg', 'img/4b.jpg', 'img/5b.jpg', 'img/6b.jpg', 'img/7b.jpg', 'img/8b.jpg', 'img/9b.jpg', 'img/10b.jpg', 'img/11b.jpg', 'img/12b.jpg', 'img/13b.jpg', 'img/14b.jpg', 'img/15b.jpg']
    }
];
        const codeToValue = { type: { s: 'standing', h: 'hanging', m: 'mug_shelf' }, color: { '0': '#8B5A2B', '1': '#FFFFFF', '2': '#000000' }, mugMount: { h: 'hanging', s: 'standing' } };
        const valueToCode = { type: { standing: 's', hanging: 'h', mug_shelf: 'm' }, color: { '#8B5A2B': '0', '#FFFFFF': '1', '#000000': '2' } };


        function updateDividerIconsVisibility() {
            if (!mugShelfDividerIconsContainer || !shelfTypeSelect || !shelfContainer) return;
            const isMobile = window.innerWidth < 768;
            const isMugShelf = shelfTypeSelect.value === 'mug_shelf';
            const is3dPanelActive = shelfContainer.classList.contains('active');

            if (isMobile && isMugShelf && is3dPanelActive) {
                mugShelfDividerIconsContainer.classList.add('visible');
                if (typeof updateMobileMountStripStates === "function") updateMobileMountStripStates();
            } else {
                mugShelfDividerIconsContainer.classList.remove('visible');
            }
        }
function updateDividerIconActiveStates() {
            if (addTopDividerBtn && dividersTopCheckbox) addTopDividerBtn.classList.toggle('active-divider-icon', dividersTopCheckbox.checked);
            if (addMiddleDividerBtn && dividersMiddleCheckbox) addMiddleDividerBtn.classList.toggle('active-divider-icon', dividersMiddleCheckbox.checked);
            if (addBottomDividerBtn && dividersBottomCheckbox) addBottomDividerBtn.classList.toggle('active-divider-icon', dividersBottomCheckbox.checked);
        }

        function updateMobileMountStripStates() {
            if (!mobileMountHangingStripBtn || !mobileMountStandingStripBtn || !mugShelfMountOptionsDiv) return;
            const currentMountValue = mugShelfMountOptionsDiv.querySelector('input[name="mugShelfMount"]:checked')?.value;
            mobileMountHangingStripBtn.classList.toggle('active-mount-strip', currentMountValue === 'hanging');
            mobileMountStandingStripBtn.classList.toggle('active-mount-strip', currentMountValue === 'standing');
        }

        function updateDividerDimensionVisibility() {
            if (!desktopDividerDimensionsInfo || !shelfTypeSelect ) {
                 return;
            }
            const isMugShelf = shelfTypeSelect.value === 'mug_shelf';
            const currentWidth = getCurrentWidth();
            const areDividersSelected = (dividersTopCheckbox?.checked || dividersMiddleCheckbox?.checked || dividersBottomCheckbox?.checked);
            const shouldShow = isMugShelf && areDividersSelected;

            try {
                if (shouldShow) {
                    const heightVal = heightSelect.value;
                    let sectionHeightCm = "n/d";
                    const thicknessCm = 1.8;
                    const numInternalShelves = shelfCountSelect ? parseInt(shelfCountSelect.value) : 0;
                    const numSections = numInternalShelves + 1;

                    if (heightVal && numInternalShelves >= 0 && numSections > 0) {
                        const totalInternalShelvesThicknessCm = numInternalShelves * thicknessCm;
                        const totalSideThicknessCm = 2 * thicknessCm;
                        const availableHeightForSectionsCm = parseFloat(heightVal) - totalSideThicknessCm - totalInternalShelvesThicknessCm;
                        if (availableHeightForSectionsCm > 0) {
                            sectionHeightCm = (availableHeightForSectionsCm / numSections).toFixed(1);
                        }
                    }

if (currentWidth === 84) {
    const numPhysicalDividers84 = 3;
    const numCompartments84 = numPhysicalDividers84 + 1;
    const compartmentWidthCm84 = 12.5;
    desktopDividerDimensionsInfo.textContent = `${numPhysicalDividers84} przegr√≥dki / ${numCompartments84} komory (w lewej po≈Çowie), szer. komory: ${compartmentWidthCm84.toFixed(1)}cm, wys. ~${sectionHeightCm}cm`;
} else if (currentWidth === 60) {
                         desktopDividerDimensionsInfo.textContent = `3 przegr√≥dki / 4 komory, szer. komory: ~${((60 - 2*1.8 - 3*1.8)/4).toFixed(1)}cm, wys. ~${sectionHeightCm}cm`;
                    } else if (currentWidth === 44) {
                         desktopDividerDimensionsInfo.textContent = `2 przegr√≥dki / 3 komory, szer. komory: ~${((44 - 2*1.8 - 2*1.8)/3).toFixed(1)}cm, wys. ~${sectionHeightCm}cm`;
                    } else {
                         desktopDividerDimensionsInfo.textContent = 'Wymiary przegr√≥dek (info)';
                    }
                }
                desktopDividerDimensionsInfo.style.display = shouldShow ? 'block' : 'none';
            } catch (e) {
                console.error("Error setting display for desktopDividerDimensionsInfo:", e);
                 if(desktopDividerDimensionsInfo) desktopDividerDimensionsInfo.style.display = 'none';
            }
        }

        function getCurrentWidth() { const widthOption = widthSelect.value; if (widthOption === 'custom') { if (customWidthInput) { return parseInt(customWidthInput.value) || 35; } else { return 35; } } else if (widthOption && widthOption !== "") { return parseInt(widthOption); } return NaN; }
        function updateDepthOptions() { const width = getCurrentWidth(); const height = heightSelect.value; const currentDepth = depthSelect.value; let availableDepths = ['10']; const widthValue = widthSelect.value; let allow15 = false; if (isNaN(width) || !height || height === "") { depthSelect.innerHTML = '<option value="">-- Wybierz --</option>'; depthSelect.value = ""; return; } if (widthValue === "custom") { const customWidth = width; const standardWidthKey = customWidth < 39 ? "34" : customWidth < 47 ? "44" : customWidth < 54 ? "50" : "60"; if (pricing[standardWidthKey]?.[height]?.['15'] && Object.keys(pricing[standardWidthKey]?.[height]?.['15']).length > 0) { allow15 = true; } } else { const standardWidthKey = String(width); if (pricing[standardWidthKey]?.[height]?.['15'] && Object.keys(pricing[standardWidthKey]?.[height]?.['15']).length > 0) { allow15 = true; } } if (allow15) availableDepths.push('15'); depthSelect.innerHTML = '<option value="">-- Wybierz --</option>'; availableDepths.forEach(depth => { const option = document.createElement('option'); option.value = depth; option.textContent = `${depth} cm`; depthSelect.appendChild(option); }); if (availableDepths.includes(currentDepth)) { depthSelect.value = currentDepth; } else { depthSelect.value = ""; } }
        function updateShelfCountOptions() { const height = heightSelect.value; const shelfType = shelfTypeSelect.value; const currentValue = shelfCountSelect.value; let options = { '0': 'brak p√≥≈Çek' }; if (!height || height === "" || shelfType === 'mug_shelf') { shelfCountSelect.innerHTML = ''; if (!height || height === "") { const option = document.createElement('option'); option.value = '0'; option.textContent = 'brak p√≥≈Çek'; shelfCountSelect.appendChild(option); shelfCountSelect.value = '0'; } return; } if (height === "40") options['2'] = '2 p√≥≈Çki'; else if (height === "60") { options['2'] = '2 p√≥≈Çki'; options['3'] = '3 p√≥≈Çki'; } else if (height === "80") { options['2'] = '2 p√≥≈Çki'; options['3'] = '3 p√≥≈Çki'; options['4'] = '4 p√≥≈Çki'; options['5'] = '5 p√≥≈Çki'; } shelfCountSelect.innerHTML = ''; for (const value in options) { const option = document.createElement('option'); option.value = value; option.textContent = options[value]; shelfCountSelect.appendChild(option); } if (options.hasOwnProperty(currentValue)) { shelfCountSelect.value = currentValue; } else { shelfCountSelect.value = '0'; } }
        function checkCustomWidth() { const isCustom = widthSelect.value === 'custom'; if(customWidthInput && customWidthDisplay && customWidthFee) { customWidthInput.style.display = isCustom ? 'block' : 'none'; customWidthDisplay.style.display = isCustom ? 'inline' : 'none'; customWidthFee.style.display = isCustom ? 'inline' : 'none'; if (isCustom) { customWidthDisplay.textContent = customWidthInput.value + ' cm'; } } handleDimensionChange(); }
        function handleDimensionChange() { if (shelfTypeSelect.value !== 'mug_shelf') { updateDepthOptions(); updateShelfCountOptions(); } updatePreview(); updateOrderSummary(); }
        function handleMugShelfHeightChange() { const height = heightSelect.value; if (shelfCountSelect && mugShelfDividersOptionsDiv) { if (height === '60') { shelfCountSelect.innerHTML = '<option value="3">3 p√≥≈Çki (sta≈Çe)</option>'; shelfCountSelect.value = '3'; mugShelfDividersOptionsDiv.style.display = 'block'; } else if (height === '40') { shelfCountSelect.innerHTML = '<option value="2">2 p√≥≈Çki (sta≈Çe)</option>'; shelfCountSelect.value = '2'; mugShelfDividersOptionsDiv.style.display = 'block'; } else { shelfCountSelect.innerHTML = '<option value="">-- Wybierz --</option>'; shelfCountSelect.value = ''; mugShelfDividersOptionsDiv.style.display = 'none'; } if(dividersTopCheckbox) dividersTopCheckbox.checked = false; if(dividersMiddleCheckbox) dividersMiddleCheckbox.checked = false; if(dividersBottomCheckbox) dividersBottomCheckbox.checked = false; } updatePreview(); updateOrderSummary(); }

        function handleShelfTypeChange(isLoading = false) {
             const shelfColorLabel = document.getElementById('shelfColorLabel'); const shelfType = shelfTypeSelect.value;
             const noTopShelfCheckbox = document.getElementById("noTopShelf"); const noBottomShelfCheckbox = document.getElementById("noBottomShelf");
             if (shelfTypeOptionsDiv) { shelfTypeOptionsDiv.innerHTML = ''; shelfTypeOptionsDiv.style.display = 'none'; }
             if (mugShelfSpecificOptionsContainer) mugShelfSpecificOptionsContainer.style.display = 'none';
             if (mugShelfMountOptionsDiv) mugShelfMountOptionsDiv.style.display = 'none';
             if (mugShelfDividersOptionsDiv) mugShelfDividersOptionsDiv.style.display = 'none';
             restoreDimensionControls(); autoRotateEnabled = true;
             heightSelect.removeEventListener('change', handleMugShelfHeightChange); widthSelect.removeEventListener('change', handleMugShelfWidthChange);
             heightSelect.removeEventListener('change', handleDimensionChange);
             heightSelect.addEventListener('change', handleDimensionChange);


             if (shelfType === 'standing' || shelfType === 'hanging') {
                 autoRotateEnabled = true; depthSelect.disabled = false; shelfCountSelect.disabled = false;
                 depthLabel.classList.remove('text-stone-400');
                 if (shelfTypeOptionsDiv) {
                     shelfTypeOptionsDiv.style.display = 'block'; if (shelfType === 'standing') { const topChecked = noTopShelfCheckbox?.checked ? 'checked' : ''; const bottomChecked = noBottomShelfCheckbox?.checked ? 'checked' : ''; shelfTypeOptionsDiv.innerHTML = `<label class="flex items-center space-x-2 text-sm cursor-pointer"><input type="checkbox" id="noTopShelf" class="rounded border-stone-300 text-green-600 shadow-sm focus:ring-green-500" onchange="updatePreview(); updateOrderSummary();" ${topChecked}> <span class="text-stone-700">Bez g√≥rnej p√≥≈Çki</span></label><label class="flex items-center space-x-2 text-sm mt-1 cursor-pointer"><input type="checkbox" id="noBottomShelf" class="rounded border-stone-300 text-green-600 shadow-sm focus:ring-green-500" onchange="updatePreview(); updateOrderSummary();" ${bottomChecked}> <span class="text-stone-700">Bez dolnej p√≥≈Çki (podstawy)</span></label>`; } else { const topChecked = noTopShelfCheckbox?.checked ? 'checked' : ''; shelfTypeOptionsDiv.innerHTML = `<label class="flex items-center space-x-2 text-sm mt-1 cursor-pointer"><input type="checkbox" id="noTopShelf" class="rounded border-stone-300 text-green-600 shadow-sm focus:ring-green-500" onchange="updatePreview(); updateOrderSummary();" ${topChecked}> <span class="text-stone-700">Bez g√≥rnej p√≥≈Çki</span></label>`; }
                 }
             } else if (shelfType === 'mug_shelf') {
                 autoRotateEnabled = false;
                 widthSelect.innerHTML = '<option value="44">44 cm</option><option value="60">60 cm</option><option value="84">84 cm</option>';
                 heightSelect.innerHTML = '<option value="40">40 cm</option><option value="60">60 cm</option>';

                 widthSelect.removeEventListener('change', checkCustomWidth); widthSelect.addEventListener('change', handleMugShelfWidthChange);
                 heightSelect.removeEventListener('change', handleDimensionChange);
                 heightSelect.addEventListener('change', handleMugShelfHeightChange);

                 if(customWidthInput && customWidthDisplay && customWidthFee){ customWidthInput.style.display = 'none'; customWidthDisplay.style.display = 'none'; customWidthFee.style.display = 'none'; }
                 depthSelect.innerHTML = '<option value="10">10 cm (sta≈Ça)</option>'; depthSelect.value = '10'; depthSelect.disabled = true;
                 depthLabel.classList.add('text-stone-400'); shelfCountSelect.disabled = true;
                 if (mugShelfSpecificOptionsContainer) mugShelfSpecificOptionsContainer.style.display = 'block';
                 if (mugShelfMountOptionsDiv) {
                     mugShelfMountOptionsDiv.style.display = 'block'; const defaultChecked = !isLoading ? 'checked' : '';
                     mugShelfMountOptionsDiv.innerHTML = `<h3 class="text-md font-semibold mb-2 text-stone-700">Spos√≥b monta≈ºu:</h3><label class="flex items-center space-x-2"><input type="radio" name="mugShelfMount" value="hanging" class="rounded-full border-stone-300 text-green-600 shadow-sm focus:ring-green-500 focus:ring-offset-0 focus:ring-2" onchange="updatePreview(); updateOrderSummary(); updateMobileMountStripStates();"> <span>WiszƒÖca</span></label><label class="flex items-center space-x-2 mt-1"><input type="radio" name="mugShelfMount" value="standing" class="rounded-full border-stone-300 text-green-600 shadow-sm focus:ring-green-500 focus:ring-offset-0 focus:ring-2" onchange="updatePreview(); updateOrderSummary(); updateMobileMountStripStates();" ${defaultChecked}><span>StojƒÖca</span></label>`;
                 }
                 if (mugShelfDividersOptionsDiv) mugShelfDividersOptionsDiv.style.display = 'none';
             }

             if (!isLoading) {
                  if (shelfType === 'standing' || shelfType === 'hanging') { if (Array.from(widthSelect.options).some(opt => opt.value === '44')) widthSelect.value = "44"; if (Array.from(heightSelect.options).some(opt => opt.value === '40')) heightSelect.value = "40"; updateDepthOptions(); if (Array.from(depthSelect.options).some(opt => opt.value === '10')) depthSelect.value = "10"; updateShelfCountOptions(); if (Array.from(shelfCountSelect.options).some(opt => opt.value === '0')) shelfCountSelect.value = "0";
                } else if (shelfType === 'mug_shelf') {
                    widthSelect.value = '44';
                    heightSelect.value = '40';
                    handleMugShelfHeightChange();
                    const standingRadio = mugShelfMountOptionsDiv?.querySelector('input[value="standing"]');
                    if (standingRadio && !standingRadio.checked) { standingRadio.checked = true;} else { const hangingRadio = mugShelfMountOptionsDiv?.querySelector('input[value="hanging"]'); if(hangingRadio) hangingRadio.checked = true; }
                }
                checkCustomWidth();
             }
             if (shelfColorLabel) { shelfColorLabel.textContent = (shelfType === 'mug_shelf') ? 'Kolor p√≥≈Çek i przegr√≥dek:' : 'Kolor p√≥≈Çek i podstaw:'; }
             if (!isLoading) { updatePreview(); updateOrderSummary(); }
             updateDividerIconsVisibility();
             if(shelfType === 'mug_shelf') updateMobileMountStripStates();
        }

        function handleMugShelfWidthChange() {
            const currentMugShelfWidth = widthSelect.value;
            let heightChangedProgrammatically = false;
            if (shelfTypeSelect && shelfTypeSelect.value === 'mug_shelf' && widthSelect && heightSelect) {
                const sixtyCmHeightOption = Array.from(heightSelect.options).find(opt => opt.value === '60');
                const fortyCmHeightOption = Array.from(heightSelect.options).find(opt => opt.value === '40');

                if (currentMugShelfWidth === '84') {
                    if (sixtyCmHeightOption) {
                        sixtyCmHeightOption.disabled = true;
                        sixtyCmHeightOption.style.textDecoration = 'line-through';
                        sixtyCmHeightOption.style.color = '#999';
                    }
                    if (heightSelect.value === '60' && sixtyCmHeightOption && sixtyCmHeightOption.disabled) {
                        if (fortyCmHeightOption && !fortyCmHeightOption.disabled) {
                            heightSelect.value = '40';
                            heightChangedProgrammatically = true;
                        }
                    }
                } else {
                    if (sixtyCmHeightOption) {
                        sixtyCmHeightOption.disabled = false;
                        sixtyCmHeightOption.style.textDecoration = '';
                        sixtyCmHeightOption.style.color = '';
                    }
                }
            }
            if (heightChangedProgrammatically && typeof handleMugShelfHeightChange === "function") {
                handleMugShelfHeightChange();
            }
            if(dividersTopCheckbox) dividersTopCheckbox.checked = false;
            if(dividersMiddleCheckbox) dividersMiddleCheckbox.checked = false;
            if(dividersBottomCheckbox) dividersBottomCheckbox.checked = false;
            updatePreview();
            updateOrderSummary();
        }
        function restoreDimensionControls() { widthSelect.innerHTML = '<option value="">-- Wybierz --</option>'; originalWidthOptions.forEach(opt => widthSelect.add(new Option(opt.text, opt.value))); widthSelect.value = ""; widthSelect.removeEventListener('change', handleMugShelfWidthChange); widthSelect.removeEventListener('change', checkCustomWidth); widthSelect.addEventListener('change', checkCustomWidth); if(customWidthInput && customWidthDisplay && customWidthFee) { customWidthInput.style.display = 'none'; customWidthDisplay.style.display = 'none'; customWidthFee.style.display = 'none'; } heightSelect.innerHTML = '<option value="">-- Wybierz --</option>'; originalHeightOptions.forEach(opt => heightSelect.add(new Option(opt.text, opt.value))); heightSelect.value = ""; heightSelect.disabled = false; if(heightLabel) heightLabel.classList.remove('text-stone-400'); depthSelect.innerHTML = '<option value="">-- Wybierz --</option>'; depthSelect.value = ""; depthSelect.disabled = false; if(depthLabel) depthLabel.classList.remove('text-stone-400'); shelfCountSelect.innerHTML = '<option value="">-- Wybierz --</option>'; shelfCountSelect.value = ""; shelfCountSelect.disabled = false; heightSelect.removeEventListener('change', handleMugShelfHeightChange); heightSelect.removeEventListener('change', handleDimensionChange); heightSelect.addEventListener('change', handleDimensionChange); }
        function init3D() { const container = threeJsCanvasWrapper; if (!container) { console.error("Three.js canvas wrapper (#threeJsCanvasWrapper) not found."); return; } scene = new THREE.Scene(); scene.background = new THREE.Color(0xf0f0f0); camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000); camera.position.set(initialCameraPosition.x, initialCameraPosition.y, initialCameraPosition.z); renderer = new THREE.WebGLRenderer({ antialias: true }); renderer.setSize(container.clientWidth, container.clientHeight); container.innerHTML = ''; container.appendChild(renderer.domElement); scene.add(new THREE.HemisphereLight(0xffffff, 0x444444, 1)); const directionalLight = new THREE.DirectionalLight(0xffffff, 0.6); directionalLight.position.set(4, 8, 3); scene.add(directionalLight); controls = new THREE.OrbitControls(camera, renderer.domElement); controls.enableDamping = true; controls.target.set(0, 0, 0); if (controls) { controls.addEventListener('start', () => { autoRotateEnabled = false; }); controls.addEventListener('end', () => { if (shelfTypeSelect && shelfTypeSelect.value !== 'mug_shelf') { autoRotateEnabled = true; } else { autoRotateEnabled = false; } }); } window.addEventListener('resize', onWindowResize, false); updatePreview(); animate(); }
        function onWindowResize() { const container = threeJsCanvasWrapper; if (!camera || !renderer || !container) return; const width = container.clientWidth; const height = container.clientHeight; if (width > 0 && height > 0) { camera.aspect = width / height; camera.updateProjectionMatrix(); renderer.setSize(width, height); } else { console.warn("Skipping resize for 3D canvas wrapper with zero dimensions."); } updateDividerIconsVisibility(); }
        function animate() { requestAnimationFrame(animate); if (autoRotateEnabled && shelfGroup) { shelfGroup.rotation.y += 0.005; } if(controls) controls.update(); if(renderer && scene && camera) renderer.render(scene, camera); }
        function makeTextSprite(message, parameters = {}) { const fontface = parameters.fontface || "Arial"; const fontsize = parameters.fontsize || 64; const canvas = document.createElement("canvas"); const context = canvas.getContext("2d"); context.font = `bold ${fontsize}px ${fontface}`; const padding = 8; const textWidth = context.measureText(message).width; canvas.width = textWidth + padding * 2; canvas.height = fontsize * 1.2 + padding * 2; context.fillStyle = "rgba(255, 255, 255, 1)"; context.fillRect(0, 0, canvas.width, canvas.height); context.strokeStyle = "rgba(0, 0, 0, 1)"; context.lineWidth = 4; context.strokeRect(0, 0, canvas.width, canvas.height); context.fillStyle = "rgba(0, 0, 0, 1)"; context.font = `bold ${fontsize}px ${fontface}`; context.fillText(message, padding, fontsize + padding); const texture = new THREE.Texture(canvas); texture.needsUpdate = true; const spriteMaterial = new THREE.SpriteMaterial({ map: texture }); const sprite = new THREE.Sprite(spriteMaterial); sprite.scale.set(canvas.width / 100, canvas.height / 100, 1.0); return sprite; }

        function updatePreview() {
            updateDividerIconActiveStates();
             if (!scene) return; if (shelfGroup) scene.remove(shelfGroup); shelfGroup = new THREE.Group(); shelfGroup.scale.set(1.2, 1.2, 1.2); shelfGroup.position.y = -1; scene.add(shelfGroup); const widthNum = getCurrentWidth(); const heightVal = heightSelect.value; const depthVal = depthSelect.value; const shelfCountVal = shelfCountSelect.value; const thickness = 0.18; const previewMaterial = new THREE.MeshStandardMaterial(originalPreviewMaterialParams); const shelfType = shelfTypeSelect.value; const dimensionsValid = !isNaN(widthNum) && widthNum > 0 && heightVal && depthVal && heightVal !== "" && depthVal !== ""; let width = 0, height = 0, depth = 0, shelfCount = 0; if (dimensionsValid) { width = widthNum / 10; height = parseFloat(heightVal) / 10; depth = parseFloat(depthVal) / 10; shelfCount = parseInt(shelfCountVal); } shelfGroup.children.filter(child => child instanceof THREE.Sprite).forEach(sprite => { if (sprite.material.map) sprite.material.map.dispose(); sprite.material.dispose(); shelfGroup.remove(sprite); }); if (dimensionsValid && width > 0 && height > 0 && depth > 0) { const noTopShelf = document.getElementById("noTopShelf")?.checked; const isMugShelfStanding = (shelfType === "mug_shelf" && document.querySelector('input[name="mugShelfMount"]:checked')?.value === 'standing'); const isStandingType = (shelfType === "standing") || isMugShelfStanding; const noBottomShelf = (isStandingType && document.getElementById("noBottomShelf")?.checked); let topPanel, bottomPanel; if (!noBottomShelf) { const bottomGeometry = new THREE.BoxGeometry(width, thickness, depth); bottomPanel = new THREE.Mesh(bottomGeometry, previewMaterial); bottomPanel.position.set(0, -height / 2 + thickness / 2, 0); shelfGroup.add(bottomPanel); } if (!noTopShelf) { const topGeometry = new THREE.BoxGeometry(width, thickness, depth); topPanel = new THREE.Mesh(topGeometry, previewMaterial); topPanel.position.set(0, height / 2 - thickness / 2, 0); shelfGroup.add(topPanel); } const sideGeometry = new THREE.BoxGeometry(thickness, height, depth); const leftSideMesh = new THREE.Mesh(sideGeometry, previewMaterial); leftSideMesh.position.set(-width / 2 + thickness / 2, 0, 0); shelfGroup.add(leftSideMesh); const rightSideMesh = new THREE.Mesh(sideGeometry, previewMaterial); rightSideMesh.position.set(width / 2 - thickness / 2, 0, 0); shelfGroup.add(rightSideMesh); const internalShelves = []; if (!isNaN(shelfCount) && shelfCount > 0) { if (shelfType === 'mug_shelf' && heightVal === '60' && shelfCount === 3 && topPanel) { const fixedGap = 1.09; const topPanelBottomY = topPanel.position.y - thickness / 2; let lastShelfY = topPanelBottomY; for (let i = 0; i < shelfCount; i++) { const shelfY = lastShelfY - fixedGap - thickness / 2; const shelfGeometry = new THREE.BoxGeometry(width - 2 * thickness, thickness, depth); const shelfMesh = new THREE.Mesh(shelfGeometry, previewMaterial); shelfMesh.position.set(0, shelfY, 0); shelfGroup.add(shelfMesh); internalShelves.push(shelfMesh); lastShelfY = shelfY - thickness / 2; } } else { const topExists = !!topPanel; const bottomExists = !!bottomPanel; const topThicknessActual = topExists ? thickness : 0; const bottomThicknessActual = bottomExists ? thickness : 0; const totalAvailableHeight = height - topThicknessActual - bottomThicknessActual; if (totalAvailableHeight >= shelfCount * thickness && (shelfCount + 1) > 0) { const gap = (totalAvailableHeight - shelfCount * thickness) / (shelfCount + 1); let startY = bottomExists ? (-height / 2 + bottomThicknessActual) : (-height / 2); for (let i = 1; i <= shelfCount; i++) { const shelfY = startY + i * gap + (i - 0.5) * thickness; const shelfGeometry = new THREE.BoxGeometry(width - 2 * thickness, thickness, depth); const shelfMesh = new THREE.Mesh(shelfGeometry, previewMaterial); shelfMesh.position.set(0, shelfY, 0); shelfGroup.add(shelfMesh); internalShelves.push(shelfMesh); } } } }

            if (shelfType === 'mug_shelf' && topPanel && bottomPanel && internalShelves.length > 0) {
                const addDividersTop = dividersTopCheckbox?.checked;
                const addDividersMiddle = dividersMiddleCheckbox?.checked;
                const addDividersBottom = dividersBottomCheckbox?.checked;
                const dividersChecked = addDividersTop || addDividersMiddle || addDividersBottom;

                if (dividersChecked) {
                    const innerWidthForDividers = width - 2 * thickness;
                    const dividerThicknessThreeJs = thickness;

                    let levels = [];
                    internalShelves.sort((a, b) => a.position.y - b.position.y);

                    if (heightVal === '60' && internalShelves.length === 3) {
                        const shelf1_bottom = internalShelves[0].position.y - thickness / 2; const shelf1_top = internalShelves[0].position.y + thickness / 2;
                        const shelf2_bottom = internalShelves[1].position.y - thickness / 2; const shelf2_top = internalShelves[1].position.y + thickness / 2;
                        const shelf3_bottom = internalShelves[2].position.y - thickness / 2; const shelf3_top = internalShelves[2].position.y + thickness / 2;
                        levels = [ { top: topPanel.position.y - thickness / 2, bottom: shelf3_top }, { top: shelf3_bottom, bottom: shelf2_top }, { top: shelf2_bottom, bottom: shelf1_top }, { top: shelf1_bottom, bottom: bottomPanel.position.y + thickness / 2 } ];
                    } else if (heightVal === '40' && internalShelves.length === 2) {
                        const lowerShelfY = internalShelves[0].position.y; const upperShelfY = internalShelves[1].position.y;
                        const lowerShelfTop = lowerShelfY + thickness / 2; const lowerShelfBottom = lowerShelfY - thickness / 2;
                        const upperShelfTop = upperShelfY + thickness / 2; const upperShelfBottom = upperShelfY - thickness / 2;
                        levels = [ { top: topPanel.position.y - thickness / 2, bottom: upperShelfTop }, { top: upperShelfBottom, bottom: lowerShelfTop }, { top: lowerShelfBottom, bottom: bottomPanel.position.y + thickness / 2 } ];
                    }

                    const drawDividersForLevel = (levelData) => {
                        const levelH = Math.max(0.01, levelData.top - levelData.bottom);
                        if (levelH <= 0.01) return;
                        const yCenter = levelData.bottom + levelH / 2;
                        const dividerGeometry = new THREE.BoxGeometry(dividerThicknessThreeJs, levelH, depth);

if (widthNum === 84) {
    const numPhysicalDividers = 3;
    const singleCompartmentWidth = 1.25;
    let currentXPos = -innerWidthForDividers / 2;

    for (let i = 0; i < numPhysicalDividers; i++) {
        currentXPos += singleCompartmentWidth;
        const dividerXCenter = currentXPos + (dividerThicknessThreeJs / 2);
        const dividerMesh = new THREE.Mesh(dividerGeometry.clone(), previewMaterial);
        dividerMesh.position.set(dividerXCenter, yCenter, 0);
        shelfGroup.add(dividerMesh);
        currentXPos += dividerThicknessThreeJs;
    }
} else {
                            const numDividersOriginal = (widthNum == 60) ? 3 : ((widthNum == 44) ? 2 : 0);
                            if (numDividersOriginal > 0) {
                                const dividerSpacing = innerWidthForDividers / (numDividersOriginal + 1);
                                for (let i = 1; i <= numDividersOriginal; i++) {
                                    const xPos = (-innerWidthForDividers / 2) + i * dividerSpacing;
                                    const dividerMesh = new THREE.Mesh(dividerGeometry.clone(), previewMaterial);
                                    dividerMesh.position.set(xPos, yCenter, 0);
                                    shelfGroup.add(dividerMesh);
                                }
                            }
                        }
                    };

if (addDividersTop && levels.length > 0) {
    drawDividersForLevel(levels[0]);
}

if (addDividersMiddle && levels.length > 1) {
    drawDividersForLevel(levels[1]);
}

if (addDividersBottom && levels.length > 2) {
    drawDividersForLevel(levels[2]);
}
                        }
                    }
                    const labelOffset = 0.5; const widthText = makeTextSprite(widthNum + " cm", { fontsize: 32 }); widthText.position.set(0, height / 2 + labelOffset, 0); shelfGroup.add(widthText); const heightText = makeTextSprite(heightVal + " cm", { fontsize: 40 }); heightText.position.set(-width / 2 - labelOffset - thickness, 0, 0); shelfGroup.add(heightText); const depthText = makeTextSprite(depthVal + " cm", { fontsize: 32 }); depthText.position.set(width / 2 + labelOffset / 2, -height / 2 - labelOffset, depth / 2); shelfGroup.add(depthText); }
        }

        function reset3DView() { if (controls && camera) { controls.reset(); camera.position.set(initialCameraPosition.x, initialCameraPosition.y, initialCameraPosition.z); controls.target.set(0, 0, 0); controls.update(); setActiveMobileIcon(null); if (shelfTypeSelect && shelfTypeSelect.value !== 'mug_shelf') { autoRotateEnabled = true; } } }

        function computePriceDetailed() {
            const shelfType = shelfTypeSelect.value;
            const widthVal = getCurrentWidth();
            const heightVal = heightSelect.value;
            const depthVal = depthSelect.value;
            const shelfCountVal = shelfCountSelect.value;

            if (!shelfType || isNaN(widthVal) || !heightVal || !depthVal || !shelfCountVal || widthVal === "" || heightVal === "" || depthVal === "" || shelfCountVal === "" || (shelfType !== 'mug_shelf' && shelfCountVal === "0")) {
                return null;
            }

            let basePrice = null;
            let extraFee = 0;
            let deduction = 0;
            let dividerFee = 0;

            if (shelfType === 'mug_shelf') {
                const selectedMountRadio = document.querySelector('input[name="mugShelfMount"]:checked');
                if (!selectedMountRadio) return null;

                if (mugShelfPricing[String(widthVal)]?.[heightVal] !== undefined) {
                    basePrice = mugShelfPricing[String(widthVal)][heightVal];
                } else {
                    return null;
                }

                const dividersTopChecked = dividersTopCheckbox?.checked;
                const dividersMiddleChecked = dividersMiddleCheckbox?.checked;
                const dividersBottomChecked = dividersBottomCheckbox?.checked;

                if (widthVal == 84) {
                    if (dividersTopChecked) dividerFee += 33;
                    if (dividersMiddleChecked) dividerFee += 33;
                    if (dividersBottomChecked) dividerFee += 33;
                } else {
                    let feePerDividerRow = 0;
                    if (widthVal == 44) feePerDividerRow = 27;
                    else if (widthVal == 60) feePerDividerRow = 40;

                    if (feePerDividerRow > 0) {
                        if (dividersTopChecked) dividerFee += feePerDividerRow;
                        if (dividersMiddleChecked) dividerFee += feePerDividerRow;
                        if (dividersBottomChecked) dividerFee += feePerDividerRow;
                    }
                }
            } else {
                let baseWidthKey;
                const isCustomWidth = widthSelect.value === 'custom';
                if (isCustomWidth) {
                    if (isNaN(widthVal) || widthVal < 35 || widthVal > 59) return null;
                    baseWidthKey = widthVal < 39 ? "34" : widthVal < 47 ? "44" : widthVal < 54 ? "50" : "60";
                    extraFee = 50;
                } else {
                    baseWidthKey = String(widthVal);
                }

                if (pricing[baseWidthKey]?.[heightVal]?.[depthVal]?.[shelfCountVal] !== undefined) {
                    basePrice = pricing[baseWidthKey][heightVal][depthVal][shelfCountVal];
                } else {
                    return null;
                }
                if (document.getElementById('noTopShelf')?.checked) deduction += 10;
                if (shelfType === 'standing' && document.getElementById('noBottomShelf')?.checked) deduction += 10;
            }

            if (basePrice === null) return null;
            const totalPrice = basePrice + extraFee + dividerFee - deduction;
            return { base: basePrice, extra: extraFee, divider: dividerFee, deduction: deduction, total: Math.max(50, totalPrice) };
        }

        function generateOrderCode() { const shelfTypeVal = shelfTypeSelect.value; const widthNum = getCurrentWidth(); const heightVal = heightSelect.value; const depthVal = depthSelect.value; const shelfCountVal = shelfCountSelect.value; const sideColorVal = sideColorSelect.value || ''; const shelfColorVal = shelfColorSelect.value || ''; const isMugShelf = shelfTypeVal === 'mug_shelf'; if (!shelfTypeVal || isNaN(widthNum) || !heightVal || !depthVal || shelfCountVal === "" || !sideColorVal || !shelfColorVal) { return null; } const shelfCountNum = parseInt(shelfCountVal); if (isNaN(shelfCountNum) || shelfCountNum < 0) { return null; } if (!isMugShelf && shelfCountNum === 0) { return null; } let mugMountVal = null; if (isMugShelf) { mugMountVal = document.querySelector('input[name="mugShelfMount"]:checked')?.value; if (!mugMountVal) { return null; } } const typeCode = valueToCode.type[shelfTypeVal]; const sideColorCode = valueToCode.color[sideColorVal]; const shelfColorCode = valueToCode.color[shelfColorVal]; if (!typeCode || !sideColorCode || !shelfColorCode) { return null; } let optionsCode = ''; if (isMugShelf) { const mountCode = mugMountVal === 'hanging' ? 'h' : 's'; let dividerCode = ''; if (dividersTopCheckbox && dividersMiddleCheckbox && dividersBottomCheckbox) { if (dividersTopCheckbox.checked) dividerCode += 'g'; if (dividersMiddleCheckbox.checked) dividerCode += 'm'; if (dividersBottomCheckbox.checked) dividerCode += 'd'; } else { return null; } if (dividerCode === '') dividerCode = 'n'; optionsCode = `${mountCode}${dividerCode}`; } else { const noTop = document.getElementById("noTopShelf")?.checked; const noBottomCheck = document.getElementById("noBottomShelf"); const noBottom = (shelfTypeVal === "standing" && noBottomCheck?.checked); if (noTop && noBottom) optionsCode = 'tb'; else if (noTop) optionsCode = 't'; else if (noBottom) optionsCode = 'b'; else optionsCode = 's'; } const codeParts = [ typeCode, String(widthNum), heightVal, depthVal, String(shelfCountNum), sideColorCode, shelfColorCode, optionsCode ]; return codeParts.join('-'); }
        function parseOrderCode(code) { if (!code) return { error: "Kod jest pusty." }; code = code.trim().toLowerCase(); const parts = code.split('-'); if (parts.length !== 8) { return { error: `Nieprawid≈Çowy format kodu (oczekiwano 8 czƒô≈õci, znaleziono ${parts.length}).` }; } const [typeCode, widthStr, heightStr, depthStr, shelfCountStr, sideColorCode, shelfColorCode, optionsCode] = parts; const typeMap = { s: 'StojƒÖca na blacie', h: 'WiszƒÖca', m: 'P√≥≈Çka na kubki' }; const colorMap = { '0': 'DƒÖb Craft Z≈Çoty', '1': 'Bia≈Çy matowy', '2': 'Czarny matowy' }; const mugMountMap = { h: 'WiszƒÖca', s: 'StojƒÖca' }; const shelfType = typeMap[typeCode]; const sideColor = colorMap[sideColorCode]; const shelfColor = colorMap[shelfColorCode]; const width = parseInt(widthStr); const height = parseInt(heightStr); const depth = parseInt(depthStr); const shelfCount = parseInt(shelfCountStr); if (!shelfType || !sideColor || !shelfColor || isNaN(width) || isNaN(height) || isNaN(depth) || isNaN(shelfCount)) { return { error: "Nieprawid≈Çowe podstawowe warto≈õci w kodzie (typ, wymiary, kolory lub liczba p√≥≈Çek)." }; } if (width < 34 || (width > 60 && width !== 84) || (width > 84) || height < 40 || height > 80 || depth < 10 || depth > 15 || shelfCount < 0 || shelfCount > 5) { return { error: "Warto≈õci wymiar√≥w lub liczby p√≥≈Çek poza dozwolonym zakresem." }; } let options = []; if (shelfType === 'P√≥≈Çka na kubki') { const mountCode = optionsCode.charAt(0); const dividerCode = optionsCode.substring(1); const mountType = mugMountMap[mountCode]; if (!mountType) return { error: `Nieprawid≈Çowy kod monta≈ºu kubka: ${mountCode}.` }; options.push(`Monta≈º: ${mountType}`); const dividers = []; if (dividerCode.includes('g')) dividers.push("g√≥ra"); if (dividerCode.includes('m')) dividers.push("≈õrodek"); if (dividerCode.includes('d')) dividers.push("d√≥≈Ç"); if (dividers.length > 0) options.push(`Przegr√≥dki: ${dividers.join(', ')}`); else if (dividerCode !== 'n') return { error: `Nieprawid≈Çowy kod przegr√≥dek: ${dividerCode}.` }; } else { if (optionsCode === 't') options.push("Bez g√≥rnej p√≥≈Çki"); else if (optionsCode === 'b' && shelfType === 'StojƒÖca na blacie') options.push("Bez dolnej p√≥≈Çki (podstawy)"); else if (optionsCode === 'tb') { options.push("Bez g√≥rnej p√≥≈Çki"); if (shelfType === 'StojƒÖca na blacie') options.push("Bez dolnej p√≥≈Çki (podstawy)"); } else if (optionsCode !== 's') return { error: `Nieprawid≈Çowy kod opcji: ${optionsCode}.` }; } if (options.length === 0 && optionsCode !== 's' && !(shelfType === 'P√≥≈Çka na kubki' && optionsCode.substring(1) === 'n')) { options.push("Standardowa"); } else if (options.length === 0) { options.push("Standardowa"); } return { code: code.toUpperCase(), shelfType, width: `${width} cm`, height: `${height} cm`, depth: `${depth} cm`, sideColor, shelfColor, shelfCount: `${shelfCount} szt.`, options: options.join(' / ') }; }
        function displayOrderDetailsInModal(details) { if (!orderDetailsModalOverlay || !orderDetailsModal || !modalOrderCodeSpan || !modalOrderSummaryP) return; if (details.error) { modalOrderCodeSpan.textContent = "B≈ÅƒÑD"; modalOrderSummaryP.innerHTML = `<p class="text-red-600 font-semibold">${details.error}</p>`; } else { modalOrderCodeSpan.textContent = details.code; let summaryHtml = ` <p><strong>Rodzaj p√≥≈Çki:</strong> ${details.shelfType}</p> <p><strong>Szeroko≈õƒá:</strong> ${details.width}</p> <p><strong>Wysoko≈õƒá:</strong> ${details.height}</p> <p><strong>G≈Çƒôboko≈õƒá:</strong> ${details.depth}</p> <p><strong>Kolor bok√≥w:</strong> ${details.sideColor}</p> <p><strong>Kolor p√≥≈Çek:</strong> ${details.shelfColor}</p> <p><strong>Ilo≈õƒá p√≥≈Çek wewn.:</strong> ${details.shelfCount}</p> <p><strong>Opcje:</strong> ${details.options}</p> <p class="mt-4 text-xs text-stone-500 italic">Uwaga: Cena nie jest przechowywana w kodzie i nie jest tutaj wy≈õwietlana.</p> `; modalOrderSummaryP.innerHTML = summaryHtml; } orderDetailsModalOverlay.classList.add('visible'); }
        function closeOrderDetailsModal() { if (!orderDetailsModalOverlay) return; orderDetailsModalOverlay.classList.remove('visible'); if (viewOrderCodeInput) viewOrderCodeInput.value = ''; }

        function updateOrderSummary() {
            const shelfColorSummaryLabel = document.getElementById('shelfColorSummaryLabel'); const currentShelfType = shelfTypeSelect.value; if (shelfColorSummaryLabel) { if (currentShelfType === 'mug_shelf') shelfColorSummaryLabel.textContent = 'Kolor p√≥≈Çek i przegr√≥dek:'; else shelfColorSummaryLabel.textContent = 'Kolor p√≥≈Çek i podstaw:'; } document.getElementById("shelfTypeSummary").textContent = currentShelfType && shelfTypeSelect.selectedIndex > 0 ? shelfTypeSelect.options[shelfTypeSelect.selectedIndex].text : "-- Wybierz --"; const mugShelfMountItem = document.getElementById("mugShelfMountSummaryItem"); const mugShelfMountSummary = document.getElementById("mugShelfMountSummary"); if (currentShelfType === 'mug_shelf') { const selectedMountRadio = document.querySelector('input[name="mugShelfMount"]:checked'); mugShelfMountSummary.textContent = selectedMountRadio ? (selectedMountRadio.value === 'hanging' ? 'WiszƒÖca' : 'StojƒÖca') : 'nie wybrano'; mugShelfMountItem.style.display = 'flex'; } else { mugShelfMountItem.style.display = 'none'; } const widthValue = getCurrentWidth(); const heightValue = heightSelect.value; const depthValue = depthSelect.value; const shelfCountValue = shelfCountSelect.value; document.getElementById("widthSummary").textContent = !isNaN(widthValue) ? widthValue + " cm" : "--"; document.getElementById("heightSummary").textContent = heightValue && heightValue !== "" ? heightValue + " cm" : "--"; document.getElementById("depthSummary").textContent = depthValue && depthValue !== "" ? depthValue + " cm" : "--"; document.getElementById("sideColorSummary").textContent = sideColorSelect.value && sideColorSelect.selectedIndex > 0 ? sideColorSelect.options[sideColorSelect.selectedIndex].text : "nie wybrano"; document.getElementById("shelfColorSummary").textContent = shelfColorSelect.value && shelfColorSelect.selectedIndex > 0 ? shelfColorSelect.options[shelfColorSelect.selectedIndex].text : "nie wybrano"; document.getElementById("shelfCountSummary").textContent = shelfCountValue !== "" ? (shelfCountSelect.options[shelfCountSelect.selectedIndex]?.text || '--') : '-- Wybierz --'; const h = parseFloat(heightValue); const sc = parseInt(shelfCountValue); const t = 1.8; let gT = "n/d"; if (!isNaN(h) && h > 0 && !isNaN(sc) && sc >= 0) { if (currentShelfType === 'mug_shelf') { const mugGapHeight = h - 2 * t; const mugGapFreeSpace = mugGapHeight - sc * t; const mugGapsCount = sc + 1; if (mugGapFreeSpace >=0 && mugGapsCount > 0) { gT = `ok. ${(mugGapFreeSpace / mugGapsCount).toFixed(1)} cm`; } else { gT = "za ma≈Ço miejsca"; } } else { const displayGapHeight = h - 2 * t; const totalShelvesThickness = sc * t; if (displayGapHeight >= totalShelvesThickness && (sc + 1) > 0) { const freeSpace = displayGapHeight - totalShelvesThickness; const gapsCount = sc + 1; const calculatedGap = freeSpace / gapsCount; gT = `${calculatedGap.toFixed(1)} cm`; } else { gT = "za ma≈Ço miejsca"; } } } else { gT = "wybierz H i S"; } document.getElementById("gapSummary").textContent = gT; document.getElementById("gapSummaryDisplay").textContent = gT; const o = []; if (currentShelfType === 'mug_shelf') { const selectedMount = document.querySelector('input[name="mugShelfMount"]:checked'); if (selectedMount) o.push(selectedMount.value === 'hanging' ? 'Monta≈º wiszƒÖcy' : 'Monta≈º stojƒÖcy'); const dividersSelected = []; if (dividersTopCheckbox?.checked) dividersSelected.push("g√≥ra"); if (dividersMiddleCheckbox?.checked) dividersSelected.push("≈õrodek"); if (dividersBottomCheckbox?.checked) dividersSelected.push("d√≥≈Ç"); if (dividersSelected.length > 0) o.push("Przegr√≥dki: " + dividersSelected.join(", ")); } else { if (document.getElementById("noTopShelf")?.checked) o.push("bez g√≥rnej p√≥≈Çki"); const isStandingType = (currentShelfType === "standing"); if (isStandingType && document.getElementById("noBottomShelf")?.checked) o.push("bez dolnej p√≥≈Çki (podstawy)"); } document.getElementById("extraOptionsSummary").textContent = o.length ? o.join(" / ") : "standardowa";
             const orderCode = generateOrderCode(); const isComplete = !!orderCode; const pH = document.getElementById("priceHint"); const orderActionsWrapper = document.getElementById("orderActionsWrapper"); const oCW = document.getElementById("orderCodeWindow"); const pSE = document.getElementById("priceSummary"); const oCVE = document.getElementById("orderCodeVisible"); const oCI = document.getElementById("orderCodeIcon"); if (oCI) oCI.classList.remove('icon-bounce'); const indicator = document.getElementById('selectionCompleteIndicator'); const footerPriceText = document.getElementById("footerPriceText"); const footerPriceDisplay = document.getElementById("footerPriceDisplay"); if (isComplete) { const pD = computePriceDetailed(); if (pD !== null) { const priceText = pD.total + " z≈Ç"; pSE.textContent = priceText; if (footerPriceText) footerPriceText.textContent = priceText; oCVE.textContent = orderCode; pH.style.display = "none"; orderActionsWrapper.style.display = "flex"; if (oCI) oCI.classList.add('icon-bounce'); if (indicator) indicator.style.display = 'inline'; if (footerPriceDisplay) footerPriceDisplay.style.cursor = 'pointer'; } else { pSE.textContent = "N/D"; if (footerPriceText) footerPriceText.textContent = ""; oCVE.textContent = "B≈ÅƒÑD CENY"; pH.textContent = "B≈ÇƒÖd obliczania ceny. Sprawd≈∫ opcje."; pH.style.display = "block"; orderActionsWrapper.style.display = "none"; oCW.style.display = "block"; if (indicator) indicator.style.display = 'none'; if (footerPriceDisplay) footerPriceDisplay.style.cursor = 'default'; } } else { pSE.textContent = ""; if (footerPriceText) footerPriceText.textContent = ""; oCVE.textContent = ""; pH.textContent = "Wybierz wszystkie parametry, aby zobaczyƒá cenƒô."; pH.style.display = "block"; orderActionsWrapper.style.display = "none"; if (oCW) oCW.style.display="block"; if (indicator) indicator.style.display = 'none'; if (footerPriceDisplay) footerPriceDisplay.style.cursor = 'default'; }
            updateDividerDimensionVisibility();
        }
        function updateSwatchDisplay(selectElementId, swatchDisplayId) { const selectElement = document.getElementById(selectElementId); const swatchDisplay = document.getElementById(swatchDisplayId); if (!selectElement || !swatchDisplay) return; const selectedOption = selectElement.options[selectElement.selectedIndex]; const color = selectedOption ? selectedOption.dataset.color : null; if (color) { swatchDisplay.style.backgroundColor = color; swatchDisplay.style.display = 'inline-block'; if (color.toUpperCase() === '#FFFFFF') { swatchDisplay.classList.add('swatch-white-display'); } else { swatchDisplay.classList.remove('swatch-white-display'); } } else { swatchDisplay.style.backgroundColor = '#E5E7EB'; swatchDisplay.classList.remove('swatch-white-display'); } }
        function copyOrderSummary() { const code = document.getElementById("orderCodeVisible").textContent; const priceText = document.getElementById("priceSummary").textContent; const priceValue = parseFloat(priceText.replace(/\s*z≈Ç/i, '').replace(',', '.')); if (!code || code === "" || code.toUpperCase().includes("B≈ÅƒÑD") || !priceText || priceText === "" || priceText === "N/D" || isNaN(priceValue)) { alert("WystƒÖpi≈Ç b≈ÇƒÖd. Konfiguracja jest niekompletna lub cena jest nieprawid≈Çowa. Nie mo≈ºna przej≈õƒá do Allegro."); return; } navigator.clipboard.writeText(code).then(() => { if (allegroOrderModalOverlay && allegroModalOrderCodeEl && allegroModalPriceEl && allegroModalUnitsInstructionEl) { allegroModalOrderCodeEl.textContent = code; allegroModalPriceEl.textContent = priceText; allegroModalUnitsInstructionEl.innerHTML = `Na stronie Allegro zam√≥w produkt w liczbie sztuk r√≥wnej cenie Twojej p√≥≈Çki (czyli <strong>${priceValue} szt.</strong>).`; allegroOrderModalOverlay.classList.add('visible'); } else { console.error("Elementy modala Allegro nie zosta≈Çy znalezione. U≈ºywam alertu zapasowego."); alert(`‚úÖ Kod zam√≥wienia skopiowany: ${code}\n\nüõí Cena: ${priceText}\n\nAllegro otworzy siƒô w nowej karcie.\n\nüìã INSTRUKCJA:\n1. Na Allegro zam√≥w ${priceValue} szt. produktu.\n2. W ‚ÄûUwagi do zakupu‚Äù wklej kod: ${code}`); window.open("https://allegro.pl/oferta/zaprojektuj-wlasna-polke-podaj-wymiar-i-wybierz-kolory-do-kuchni-pokoju-17253898746", "_blank"); } }).catch(err => { console.error('B≈ÇƒÖd kopiowania do schowka: ', err); alert('Nie uda≈Ço siƒô skopiowaƒá kodu zam√≥wienia do schowka. Spr√≥buj rƒôcznie lub sprawd≈∫ uprawnienia przeglƒÖdarki.'); }); }
        function downloadOrderSummary() { const shelfType = document.getElementById("shelfTypeSummary").textContent; const mugShelfMount = shelfType === 'P√≥≈Çka na kubki' ? document.getElementById("mugShelfMountSummary").textContent : ''; const width = document.getElementById("widthSummary").textContent; const height = document.getElementById("heightSummary").textContent; const depth = document.getElementById("depthSummary").textContent; const sideColor = document.getElementById("sideColorSummary").textContent; const shelfColor = document.getElementById("shelfColorSummary").textContent; const shelfCount = document.getElementById("shelfCountSummary").textContent; const gap = document.getElementById("gapSummary").textContent; const extraOptions = document.getElementById("extraOptionsSummary").textContent; const price = document.getElementById("priceSummary").textContent; const orderCode = document.getElementById("orderCodeVisible").textContent; if (!orderCode || orderCode === "" || orderCode.toUpperCase().includes("B≈ÅƒÑD") || !price || price === "" || price === "N/D") { alert("WystƒÖpi≈Ç b≈ÇƒÖd, konfiguracja jest niekompletna lub niedostƒôpna."); return; } let content = `üì¶ Podsumowanie Zam√≥wienia\n\n* Rodzaj p√≥≈Çki: ${shelfType}\n`; if (mugShelfMount && mugShelfMount !== 'nie wybrano') { content += `* Monta≈º: ${mugShelfMount}\n`; } content += `* Szeroko≈õƒá: ${width}\n* Wysoko≈õƒá: ${height}\n* G≈Çƒôboko≈õƒá: ${depth}\n\n* Kolor bok√≥w: ${sideColor}\n* Kolor p√≥≈Çek i podstaw: ${shelfColor}\n\n* Ilo≈õƒá p√≥≈Çek wewn.: ${shelfCount}\n* Odleg≈Ço≈õƒá miƒôdzy p√≥≈Çkami: ${gap}\n* Opcje dodatkowe: ${extraOptions}\n\n* Materia≈Ç: p≈Çyta laminowana gr. 1,8 cm\n* Termin realizacji: 5‚Äë7 dni roboczych\n\nCena: ${price}\nKod zam√≥wienia: ${orderCode}`; const blob = new Blob([content], { type: "text/plain;charset=utf-8" }); const url = URL.createObjectURL(blob); const link = document.createElement("a"); link.href = url; link.download = `zamowienie-${orderCode}.txt`; document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(url); }
        function closeDetailsPanelIfNeeded() { const detailsPanel = document.getElementById('materialSamplesDetails'); if (detailsPanel && detailsPanel.open) { detailsPanel.open = false; } }
        function setActiveMobileIcon(clickedButton) { const mobileIconsContainer = document.getElementById('mobilePanelIcons'); if (!mobileIconsContainer) return; const buttons = mobileIconsContainer.querySelectorAll('button'); buttons.forEach(button => { button.classList.remove('mobile-icon-active'); }); if (clickedButton && buttons.length > 0) { clickedButton.classList.add('mobile-icon-active'); } }
        function scrollToElementAndHighlight(elementId, blockPosition = 'start', clickedButton = null, inlinePosition = 'nearest') { const element = document.getElementById(elementId); if (element) { let highlightTarget = element.closest('.p-6.shadow.rounded-lg'); if (!highlightTarget) { highlightTarget = element.closest('.w-full.max-w-lg') || element; } document.querySelectorAll('.section-highlight-persistent').forEach(el => { if (el !== highlightTarget) { el.classList.remove('section-highlight-persistent'); } }); highlightTarget.scrollIntoView({ behavior: 'smooth', block: blockPosition, inline: inlinePosition }); if (clickedButton) { setActiveMobileIcon(clickedButton); } highlightTarget.classList.remove('section-highlight-flash'); void highlightTarget.offsetWidth; highlightTarget.classList.add('section-highlight-flash'); highlightTarget.classList.add('section-highlight-persistent'); setTimeout(() => { highlightTarget.classList.remove('section-highlight-flash'); }, 750); } else { console.error('Nie znaleziono elementu o ID do pod≈õwietlenia:', elementId); } }
        function scrollToElement(elementId, blockPosition = 'start', clickedButton = null, inlinePosition = 'nearest') { const element = document.getElementById(elementId); if (element) { let targetElement = element.closest('.p-6.shadow.rounded-lg') || element.closest('.w-full.max-w-lg') || element; targetElement.scrollIntoView({ behavior: 'smooth', block: blockPosition, inline: inlinePosition }); } else { console.error('Nie znaleziono elementu o ID (scrollToElement):', elementId); } }
        function scrollToBottom() { window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' }); }

        // NOWE FUNKCJE DLA LIGHTBOXA
        function openLightbox(imageSrc) {
            if (imageLightbox && lightboxImage) {
                lightboxImage.setAttribute('src', imageSrc);
                imageLightbox.classList.remove('hidden');
                imageLightbox.classList.remove('opacity-0'); // Dla p≈Çynnego wej≈õcia, je≈õli u≈ºywasz klas opacity
                // Mo≈ºna dodaƒá zablokowanie scrollowania t≈Ça
                document.body.style.overflow = 'hidden';
            }
        }

        function closeLightbox() {
            if (imageLightbox) {
                imageLightbox.classList.add('hidden');
                imageLightbox.classList.add('opacity-0'); // Dla p≈Çynnego wyj≈õcia
                 // Przywr√≥cenie scrollowania t≈Ça
                document.body.style.overflow = '';
            }
        }

        function initializeTabbedGallery() {
            if (!galleryTabsContainer || !galleryGridContainer || !galleryImageArea || !configuratorSection || !galleryPrevArrow || !galleryNextArrow) {
                console.error("Nie znaleziono wszystkich element√≥w galerii potrzebnych do inicjalizacji."); return;
            }
            const scrollToConfig = () => {
                configuratorSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            };
            const displayImages = (galleryIndex) => {
                galleryGridContainer.innerHTML = '';
                const images = galleryData[galleryIndex].imgs;
                const fragment = document.createDocumentFragment();
                images.forEach((imgDataOrSrc, i) => {
                    const imgSrc = typeof imgDataOrSrc === 'string' ? imgDataOrSrc : imgDataOrSrc.src;
                    const tileDiv = document.createElement('div');
                    tileDiv.className = 'gallery-tile'; // Dodajemy klasƒô do kontroli widoczno≈õci paska akcji

                    const imgContainer = document.createElement('div');
                    imgContainer.className = 'gallery-image-container'; // Upewnij siƒô, ≈ºe ten kontener ma position: relative

                    const img = document.createElement('img');
                    img.src = imgSrc;
                    img.alt = `${galleryData[galleryIndex].title} - zdjƒôcie ${i + 1}`;
                    img.loading = 'lazy';
                    imgContainer.appendChild(img);

                    // ---- POCZƒÑTEK MODYFIKACJI: Dodanie nowego paska akcji ----
                    const actionBarHTML = `
                        <div class="image-actions-bar">
                            <button class="action-icon-btn gallery-zoom-btn" title="Powiƒôksz">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607zM10.5 7.5v6m3-3h-6" /></svg>
                            </button>
                            <button class="action-icon-btn gallery-configure-btn" title="Konfiguruj">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 010 1.905c-.007.379.137.75.431.99l1.005.828c.428.355.53 1.005.26 1.43l-1.298 2.247a1.125 1.125 0 01-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.063-.374-.313-.686-.644-.87a6.52 6.52 0 01-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 01-1.369-.49l-1.297-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 010-1.905c.007-.379-.137-.75-.43-.99l-1.004-.828a1.125 1.125 0 01-.26-1.43l1.297-2.247a1.125 1.125 0 011.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                            </button>
                        </div>
                    `;
                    imgContainer.insertAdjacentHTML('beforeend', actionBarHTML);
                    // ---- KONIEC MODYFIKACJI: Dodanie nowego paska akcji ----

                    // Komentujemy stary przycisk .config-btn, aby uniknƒÖƒá konfliktu
                    /*
                    const configBtn = document.createElement('div');
                    configBtn.className = 'config-btn';
                    configBtn.title = 'Kliknij, aby przej≈õƒá do konfiguracji';
                    configBtn.innerHTML = '<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3.25"/><path d="M19.428 15.34a9.05 9.05 0 0 0 .05-6.68l-1.46-.84.51-1.77-2.12-2.12-1.77.51-.84-1.46a9.05 9.05 0 0 0-6.68 0l-.84 1.46-1.77-.51-2.12 2.12.51 1.77-1.46.84a9.05 9.05 0 0 0 0 6.68l1.46.84-.51 1.77 2.12 2.12 1.77-.51.84 1.46a9.05 9.05 0 0 0 6.68 0l.84-1.46 1.77.51 2.12-2.12-.51-1.77 1.46-.84z"/></svg>';
                    imgContainer.appendChild(configBtn);
                    */

                    const captionDiv = document.createElement('div');
                    captionDiv.className = 'gallery-caption';
                    captionDiv.textContent = 'Konfiguruj p√≥≈Çkƒô'; // Ten tekst jest na hover, mo≈ºe zostaƒá
                    tileDiv.appendChild(imgContainer);
                    tileDiv.appendChild(captionDiv);

                    // ---- POCZƒÑTEK MODYFIKACJI: Nowe listenery ----
                    // Listener na ca≈Çy kafelek - POKA≈ª/UKRYJ PASEK AKCJI
                    tileDiv.addEventListener('click', function(event) {
                        // Je≈õli klikniƒôto bezpo≈õrednio na przycisk w pasku akcji, nie r√≥b nic (obs≈Çu≈ºƒÖ to listenery przycisk√≥w)
                        if (event.target.closest('.action-icon-btn')) {
                            return;
                        }

                        // Ukryj wszystkie inne otwarte paski akcji
                        document.querySelectorAll('.gallery-tile.actions-visible').forEach(activeTile => {
                            if (activeTile !== tileDiv) {
                                activeTile.classList.remove('actions-visible');
                            }
                        });
                        // Poka≈º/ukryj pasek akcji dla tego kafelka
                        tileDiv.classList.toggle('actions-visible');
                    });

                    // Listenery dla przycisk√≥w w nowym pasku akcji
                    const currentZoomBtn = imgContainer.querySelector('.gallery-zoom-btn');
                    const currentConfigureBtn = imgContainer.querySelector('.gallery-configure-btn');

                    if (currentZoomBtn) {
                        currentZoomBtn.addEventListener('click', (e) => {
                            e.stopPropagation(); // Zapobiegaj propagacji do tileDiv
                            openLightbox(imgSrc);
                        });
                    }

                    if (currentConfigureBtn) {
                        currentConfigureBtn.addEventListener('click', (e) => {
                            e.stopPropagation(); // Zapobiegaj propagacji do tileDiv
                            const allTiles = galleryGridContainer.querySelectorAll('.gallery-tile');
                            allTiles.forEach(t => t.classList.remove('gallery-tile--active'));
                            tileDiv.classList.add('gallery-tile--active');
                            applyShelfConfigurationFromGallery(galleryIndex, i);
                            scrollToConfig();
                            tileDiv.classList.remove('actions-visible'); // Opcjonalnie: ukryj pasek po klikniƒôciu konfiguruj
                        });
                    }
                    // ---- KONIEC MODYFIKACJI: Nowe listenery ----

                    // Usuniƒôcie starych listener√≥w z configBtn, je≈õli by≈Çyby aktywne
                    // configBtn.addEventListener('click', (e) => { e.stopPropagation(); handleTileClick(); });

                    fragment.appendChild(tileDiv);
                });
                galleryGridContainer.appendChild(fragment);
                galleryImageArea.scrollLeft = 0;
            };
            galleryData.forEach((gallery, index) => {
                const tab = document.createElement('button');
                tab.className = 'gallery-tab';
                tab.textContent = gallery.title;
                tab.dataset.index = index;
                if (index === 0) { tab.classList.add('active'); }
                tab.addEventListener('click', () => {
                    galleryTabsContainer.querySelectorAll('.gallery-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    const allTilesInGrid = galleryGridContainer.querySelectorAll('.gallery-tile');
                    allTilesInGrid.forEach(item => {
                        item.classList.remove('gallery-tile--active');
                        item.classList.remove('actions-visible'); // Ukryj paski akcji przy zmianie taba
                    });
                    displayImages(index);
                });
                galleryTabsContainer.appendChild(tab);
            });
            galleryNextArrow.addEventListener('click', () => { galleryImageArea.scrollBy({ left: galleryImageArea.clientWidth * 0.8, behavior: 'smooth' }); });
            galleryPrevArrow.addEventListener('click', () => { galleryImageArea.scrollBy({ left: -galleryImageArea.clientWidth * 0.8, behavior: 'smooth' }); });
            if (galleryData.length > 0) { displayImages(0); }
        }
        function initializeReviews() { const reviews = [ '"Fantastyczna p√≥≈Çeczka, przysz≈Ça od razu zmontowana i idealnie pasuje w wielu miejscach. Serdecznie polecam!"', '"Piƒôkna, zgrabna p√≥≈Çka. Solidnie wykonana, bez ≈ºadnych wad. Polecam!"', '"Bardzo ≈Çadna i funkcjonalna p√≥≈Çka, ≈õwietnie zapakowana na czas transportu. Polecam!"', '"Super produkt ‚Äì piƒôknie wykonany, idealnie pasuje do ma≈Çych s≈Çoiczk√≥w z przyprawami w kuchni. Polecam!"', '"≈Åadna i solidna p√≥≈Çka, starannie wykonana. Kolor ≈õwietnie wpasowa≈Ç siƒô w meble. Polecam!"' ]; let currentReviewIndex = 0; const reviewDisplay = document.getElementById('customerReview'); function showNextReview() { if (!reviewDisplay) return; reviewDisplay.classList.remove('review-fade-enter-active'); setTimeout(() => { const reviewData = reviews[currentReviewIndex]; reviewDisplay.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-lime-500 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" /></svg> ${reviewData}`; reviewDisplay.classList.add('review-fade-enter-active'); currentReviewIndex = (currentReviewIndex + 1) % reviews.length; }, 700); } if (reviewDisplay) { showNextReview(); setInterval(showNextReview, 6000); } }
        function open3dPanel() { if (shelfContainer) { shelfContainer.classList.add('active'); setTimeout(onWindowResize, 50); updateDividerIconsVisibility(); updateMobileMountStripStates(); } else { console.error("Nie mo≈ºna otworzyƒá panelu 3D - brak elementu #shelfContainer"); } }
        function close3dPanel() { if (shelfContainer) { shelfContainer.classList.remove('active'); setActiveMobileIcon(null); updateDividerIconsVisibility(); } }
        function initialize3dPanel() { show3dButton = document.getElementById('show3dButton'); collapse3dPanelButton = document.getElementById('collapse3dPanelButton'); if (show3dButton && collapse3dPanelButton && shelfContainer) { show3dButton.addEventListener('click', open3dPanel); console.log("Panel 3D zainicjalizowany."); } else { let missing = []; if (!show3dButton) missing.push("show3dButton"); if (!collapse3dPanelButton) missing.push("collapse3dPanelButton (lub jego odpowiednik)"); if (!shelfContainer) missing.push("shelfContainer"); console.warn(`Nie znaleziono element√≥w panelu 3D: ${missing.join(', ')}. Funkcjonalno≈õƒá mo≈ºe nie dzia≈Çaƒá poprawnie.`); } }

        document.addEventListener('DOMContentLoaded', () => {
            shelfContainer = document.getElementById('shelfContainer'); threeJsCanvasWrapper = document.getElementById('threeJsCanvasWrapper'); shelfTypeSelect = document.getElementById('shelfType'); widthSelect = document.getElementById('width'); heightSelect = document.getElementById('height'); depthSelect = document.getElementById('depth'); shelfCountSelect = document.getElementById('shelfCount'); customWidthInput = document.getElementById('customWidthInput'); customWidthDisplay = document.getElementById('customWidthDisplay'); customWidthFee = document.getElementById('customWidthFee'); shelfTypeOptionsDiv = document.getElementById('shelfTypeOptions'); widthSelectionArea = document.getElementById('widthSelectionArea'); dimensionSectionAnchor = document.getElementById('dimensionSectionAnchor'); colorSectionAnchor = document.getElementById('colorSectionAnchor'); shelfTypeSectionAnchor = document.getElementById('shelfTypeSectionAnchor'); heightLabel = document.getElementById('heightLabel'); depthLabel = document.getElementById('depthLabel'); sideColorSelect = document.getElementById('sideColor'); shelfColorSelect = document.getElementById('shelfColor'); mugShelfSpecificOptionsContainer = document.getElementById('mugShelfSpecificOptionsContainer'); mugShelfMountOptionsDiv = document.getElementById('mugShelfMountOptions'); mugShelfDividersOptionsDiv = document.getElementById('mugShelfDividersOptions'); dividersTopCheckbox = document.getElementById('dividersTop'); dividersMiddleCheckbox = document.getElementById('dividersMiddle'); dividersBottomCheckbox = document.getElementById('dividersBottom'); configuratorSection = document.getElementById('configuratorSection'); shelfCountSection = document.getElementById('shelfCountSection'); galleryTabsContainer = document.getElementById('galleryTabsContainer'); galleryGridContainer = document.getElementById('galleryGridContainer'); galleryImageArea = document.getElementById('galleryImageArea'); galleryPrevArrow = document.querySelector('.gallery-prev-arrow'); galleryNextArrow = document.querySelector('.gallery-next-arrow'); footerPriceTextElement = document.getElementById('footerPriceText'); selectionCompleteIndicator = document.getElementById('selectionCompleteIndicator');
            mugShelfDividerIconsContainer = document.getElementById('mugShelfDividerIconsContainer'); addTopDividerBtn = document.getElementById('addTopDividerBtn'); addMiddleDividerBtn = document.getElementById('addMiddleDividerBtn'); addBottomDividerBtn = document.getElementById('addBottomDividerBtn'); mobileMugShelfMountStripsContainer = document.getElementById('mobileMugShelfMountStripsContainer'); mobileMountHangingStripBtn = document.getElementById('mobileMountHangingStripBtn'); mobileMountStandingStripBtn = document.getElementById('mobileMountStandingStripBtn');
            desktopDividerDimensionsInfo = document.getElementById('desktopDividerDimensionsInfo');
            viewOrderCodeInput = document.getElementById('viewOrderCodeInput'); orderDetailsModalOverlay = document.getElementById('orderDetailsModalOverlay'); orderDetailsModal = document.getElementById('orderDetailsModal'); modalCloseButton = orderDetailsModal ? orderDetailsModal.querySelector('.modal-close-button') : null; modalOrderCodeSpan = document.getElementById('modalOrderCode'); modalOrderSummaryP = document.getElementById('modalOrderSummary');
            allegroOrderModalOverlay = document.getElementById('allegroOrderModalOverlay'); allegroModalOrderCodeEl = document.getElementById('allegroModalOrderCode'); allegroModalPriceEl = document.getElementById('allegroModalPrice'); allegroModalUnitsInstructionEl = document.getElementById('allegroModalInstructionUnits'); allegroModalGoButton = document.getElementById('allegroModalGoButton'); allegroModalCloseButtonTop = document.getElementById('allegroModalCloseButtonTop'); allegroModalCloseButtonBottom = document.getElementById('allegroModalCloseButtonBottom');

            // NOWE: Inicjalizacja element√≥w Lightboxa
            imageLightbox = document.getElementById('imageLightbox');
            lightboxImage = document.getElementById('lightboxImage');
            lightboxCloseBtn = document.getElementById('lightboxClose');


             if (!shelfContainer || !threeJsCanvasWrapper || !shelfTypeSelect || !widthSelect || !heightSelect || !depthSelect || !shelfCountSelect || !sideColorSelect || !shelfColorSelect || !mugShelfMountOptionsDiv || !dividersTopCheckbox || !dividersMiddleCheckbox || !dividersBottomCheckbox || !addTopDividerBtn || !addMiddleDividerBtn || !addBottomDividerBtn || !mobileMountHangingStripBtn || !mobileMountStandingStripBtn || !desktopDividerDimensionsInfo) { console.error("B≈ÅƒÑD KRYTYCZNY: Nie znaleziono wszystkich wymaganych element√≥w DOM. Inicjalizacja przerwana."); return; }
             if(widthSelect) originalWidthOptions = Array.from(widthSelect.options).map(opt => ({value: opt.value, text: opt.text})).filter(opt => opt.value !== ""); if(heightSelect) originalHeightOptions = Array.from(heightSelect.options).map(opt => ({value: opt.value, text: opt.text})).filter(opt => opt.value !== "");

            try {
                 if (shelfTypeSelect) shelfTypeSelect.value = ""; if (widthSelect && Array.from(widthSelect.options).some(opt => opt.value === '44')) { widthSelect.value = "44"; if (typeof checkCustomWidth === 'function') checkCustomWidth(); } if (heightSelect && Array.from(heightSelect.options).some(opt => opt.value === '40')) heightSelect.value = "40"; if (typeof updateDepthOptions === 'function') updateDepthOptions(); if (depthSelect && Array.from(depthSelect.options).some(opt => opt.value === '10')) depthSelect.value = "10"; if (typeof updateShelfCountOptions === 'function') updateShelfCountOptions(); if (shelfCountSelect && Array.from(shelfCountSelect.options).some(opt => opt.value === '0')) shelfCountSelect.value = "0";
                if(typeof init3D === 'function') init3D(); else console.error("init3D is not defined");
                if(typeof updateSwatchDisplay === 'function') { updateSwatchDisplay('sideColor', 'sideColorSwatchDisplay'); updateSwatchDisplay('shelfColor', 'shelfColorSwatchDisplay'); } else console.error("updateSwatchDisplay is not defined");
                updatePreview();
                updateOrderSummary();

                if(typeof initializeTabbedGallery === 'function') initializeTabbedGallery(); else console.error("initializeTabbedGallery is not defined");
                if(typeof initialize3dPanel === 'function') initialize3dPanel(); else console.error("initialize3dPanel is not defined");
                if(typeof initializeReviews === 'function') initializeReviews(); else console.error("initializeReviews is not defined");

                const setupDividerButton = (btn, checkbox) => {
                    if (!btn || !checkbox) { console.error("setupDividerButton: Missing button or checkbox."); return; }
                    btn.addEventListener('click', () => {
                        checkbox.checked = !checkbox.checked;
                        updateDividerIconActiveStates(); updatePreview(); updateOrderSummary();
                    });
                    checkbox.addEventListener('change', () => {
                        updateDividerIconActiveStates();
                    });
                };
                setupDividerButton(addTopDividerBtn, dividersTopCheckbox);
                setupDividerButton(addMiddleDividerBtn, dividersMiddleCheckbox);
                setupDividerButton(addBottomDividerBtn, dividersBottomCheckbox);

                const setupMobileMountStrip = (stripBtn, mountValue) => {
                     if (!stripBtn || !mugShelfMountOptionsDiv) { console.error("setupMobileMountStrip: Missing strip button or mount options div."); return; }
                     stripBtn.addEventListener('click', () => {
                         const radioToSelect = mugShelfMountOptionsDiv.querySelector(`input[name="mugShelfMount"][value="${mountValue}"]`);
                         if (radioToSelect && !radioToSelect.checked) {
                             radioToSelect.checked = true;
                             radioToSelect.dispatchEvent(new Event('change', { bubbles: true }));
                         }
                     });
                };
                setupMobileMountStrip(mobileMountHangingStripBtn, 'hanging');
                setupMobileMountStrip(mobileMountStandingStripBtn, 'standing');

                window.addEventListener('resize', updateDividerIconsVisibility);
                updateDividerIconsVisibility(); updateDividerIconActiveStates(); updateMobileMountStripStates(); updateDividerDimensionVisibility();

                const detailsPanel = document.getElementById('materialSamplesDetails'); if (detailsPanel) { detailsPanel.addEventListener('toggle', function initMaterialSwiperOnToggle() { if (detailsPanel.open && !materialSwiperInstance) { if (typeof Swiper === 'undefined') { console.error("Swiper library not loaded!"); return; } try { materialSwiperInstance = new Swiper('#materialSwiper', { slidesPerView: 1, spaceBetween: 10, navigation: { nextEl: '.material-swiper-button-next', prevEl: '.material-swiper-button-prev' }, observer: true, observeParents: true }); } catch (swiperError) { console.error("B≈ÇƒÖd inicjalizacji Swipera:", swiperError); } } else if (detailsPanel.open && materialSwiperInstance) { materialSwiperInstance.update(); } }); document.addEventListener('click', function(event) { if (detailsPanel.open && !detailsPanel.contains(event.target)) { detailsPanel.open = false; } }); } else { console.warn("Element panelu pr√≥bek (#materialSamplesDetails) nie znaleziony."); }
                const formElementsToMonitor = document.querySelectorAll('#shelfType, #width, #customWidthInput, #height, #depth, #shelfCount, #sideColor, #shelfColor'); formElementsToMonitor.forEach(element => { const eventType = (element.type === 'range') ? 'input' : 'change'; element.addEventListener(eventType, closeDetailsPanelIfNeeded); }); const configPanelContainer = document.querySelector('.w-full.md\\:w-1\\/3.space-y-8'); if (configPanelContainer) { configPanelContainer.addEventListener('change', function(event) { if (event.target.matches('#shelfTypeOptions input[type="checkbox"], #mugShelfSpecificOptionsContainer input[type="checkbox"], #mugShelfSpecificOptionsContainer input[type="radio"]')) { closeDetailsPanelIfNeeded(); } }); } else { document.body.addEventListener('change', function(event) { if (event.target.matches('#noTopShelf, #noBottomShelf, #dividersTop, #dividersMiddle, #dividersBottom, input[name="mugShelfMount"]')) { closeDetailsPanelIfNeeded(); } }); }
                if (viewOrderCodeInput) { viewOrderCodeInput.addEventListener('paste', (event) => { const pastedText = (event.clipboardData || window.clipboardData).getData('text'); if (pastedText && pastedText.trim().length > 0) { setTimeout(() => { const details = parseOrderCode(viewOrderCodeInput.value); displayOrderDetailsInModal(details); viewOrderCodeInput.blur(); }, 50); } }); viewOrderCodeInput.addEventListener('input', (event) => { const code = event.target.value.trim(); if (code.length >= 15 && code.includes('-')) { const details = parseOrderCode(code); if (!details.error || (details.error && code.length > 5)) { displayOrderDetailsInModal(details); viewOrderCodeInput.blur(); } } }); viewOrderCodeInput.addEventListener('keydown', (event) => { if (event.key === 'Enter') { event.preventDefault(); const code = viewOrderCodeInput.value.trim(); if (code) { const details = parseOrderCode(code); displayOrderDetailsInModal(details); viewOrderCodeInput.blur(); } } }); } else { console.error("Nie znaleziono elementu #viewOrderCodeInput."); }
                if (modalCloseButton) { modalCloseButton.addEventListener('click', closeOrderDetailsModal); } else { console.error("Nie znaleziono przycisku zamykania modala szczeg√≥≈Ç√≥w zam√≥wienia."); }
                if (orderDetailsModalOverlay) { orderDetailsModalOverlay.addEventListener('click', (event) => { if (event.target === orderDetailsModalOverlay) { closeOrderDetailsModal(); } }); } else { console.error("Nie znaleziono elementu #orderDetailsModalOverlay."); }
                if (allegroOrderModalOverlay && allegroModalGoButton && allegroModalCloseButtonTop && allegroModalCloseButtonBottom) { const closeAllegroModal = () => allegroOrderModalOverlay.classList.remove('visible'); allegroModalCloseButtonTop.addEventListener('click', closeAllegroModal); allegroModalCloseButtonBottom.addEventListener('click', closeAllegroModal); allegroModalGoButton.addEventListener('click', () => { window.open("https://allegro.pl/oferta/zaprojektuj-wlasna-polke-podaj-wymiar-i-wybierz-kolory-do-kuchni-pokoju-17253898746", "_blank"); closeAllegroModal(); }); allegroOrderModalOverlay.addEventListener('click', (event) => { if (event.target === allegroOrderModalOverlay) { closeAllegroModal(); } }); } else { console.error("Nie znaleziono wszystkich element√≥w nowego modala Allegro do przypisania event listener√≥w."); }
                if (window.innerWidth < 768) { const reviewBlock = document.getElementById('customerReview')?.parentElement; const summarySection = document.querySelector('.w-full.md\\:w-1\\/3.order-3'); if (reviewBlock && summarySection && reviewBlock.parentElement !== summarySection) { summarySection.appendChild(reviewBlock); } }
                const mainConfigSection = document.getElementById('configuratorSection'); if (mainConfigSection) { mainConfigSection.addEventListener('change', function(event) { if (event.target.tagName === 'SELECT' && event.target.closest('.p-6.shadow.rounded-lg, .w-full.max-w-lg')) { const parentSection = event.target.closest('.section-highlight-persistent'); if (parentSection) { parentSection.classList.remove('section-highlight-persistent'); } } }); } else { console.error("Nie znaleziono g≈Ç√≥wnego kontenera konfiguracji (#configuratorSection) do nas≈Çuchiwania zmian."); }

                // NOWE: Listenery dla Lightboxa
                if (lightboxCloseBtn) {
                    lightboxCloseBtn.addEventListener('click', closeLightbox);
                }
                if (imageLightbox) {
                    imageLightbox.addEventListener('click', function(event) {
                        // Zamknij lightbox tylko je≈õli klikniƒôto bezpo≈õrednio na t≈Ço (overlay)
                        if (event.target === imageLightbox) {
                            closeLightbox();
                        }
                    });
                }
                 // Zamykanie lightboxa klawiszem Escape
                document.addEventListener('keydown', function(event) {
                    if (event.key === 'Escape' && imageLightbox && !imageLightbox.classList.contains('hidden')) {
                        closeLightbox();
                    }
                });


                console.log("Inicjalizacja zako≈Ñczona pomy≈õlnie.");

             } catch (error) {
                 console.error("B≈ÇƒÖd podczas inicjalizacji w DOMContentLoaded:", error);
                 const body = document.querySelector('body');
                 if (body) {
                     const errorMsg = document.createElement('p');
                     errorMsg.textContent = "WystƒÖpi≈Ç b≈ÇƒÖd podczas ≈Çadowania konfiguratora. Spr√≥buj od≈õwie≈ºyƒá stronƒô.";
                     errorMsg.className = "text-red-600 font-bold text-center p-4 bg-red-100 fixed top-0 left-0 right-0 z-50";
                     body.prepend(errorMsg);
                 }
             }
        });
    </script>

    <div id="stickyFooterBar" class="fixed bottom-0 left-0 w-full bg-green-600 shadow-[0_-3px_6px_rgba(0,0,0,0.06)] flex justify-around items-stretch md:hidden z-50">
        <button onclick="scrollToElementAndHighlight('dimensionSectionAnchor', 'start', this)" title="Przewi≈Ñ do wymiar√≥w"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"> <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12h15m0 0l-6.75-6.75M19.5 12l-6.75 6.75" /> <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3.75v16.5M20.25 3.75v16.5" /> </svg> <span>Wymiary</span> </button>
        <button onclick="scrollToElementAndHighlight('colorSectionAnchor', 'start', this)" title="Przewi≈Ñ do kolor√≥w"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"> <path stroke-linecap="round" stroke-linejoin="round" d="M9.53 16.122a3 3 0 00-5.78 1.128 2.25 2.25 0 01-2.4 2.245 4.5 4.5 0 008.4-2.245c0-.399-.078-.78-.22-1.128zm0 0a15.998 15.998 0 003.388-1.62m-5.043-.025a15.994 15.994 0 011.622-3.395m3.42 3.42a15.995 15.995 0 004.764-4.648l3.876-5.814a1.151 1.151 0 00-1.597-1.597L14.146 6.32a15.996 15.996 0 00-4.649 4.763m3.42 3.42a6.776 6.776 0 00-3.42-3.42" /> </svg> <span>Kolory</span> </button>
        <button onclick="scrollToElementAndHighlight('shelfCountSection', 'center', this)" title="Przewi≈Ñ do dodawania p√≥≈Çek"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"> <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /> <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 9h16.5M3.75 15h16.5" /> </svg> <span>P√≥≈Çki</span> </button>
        <button id="show3dButton" title="Poka≈º/ukryj podglƒÖd 3D"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="animate-spin-slow"> <path stroke-linecap="round" stroke-linejoin="round" d="M21 7.5l-9-5.25L3 7.5m18 0l-9 5.25m9-5.25v9l-9 5.25M3 7.5l9 5.25M3 7.5v9l9 5.25m0-9.75l-9 5.25M12 21v-9.75" /> </svg> <span>Zobacz 3D</span> </button>
         <div id="footerPriceDisplay" class="text-white px-1 flex items-center justify-center" onclick="scrollToBottom()" title="Przewi≈Ñ na d√≥≈Ç strony"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"> <path stroke-linecap="round" stroke-linejoin="round" d="M9.568 3H5.25A2.25 2.25 0 003 5.25v4.318c0 .597.237 1.17.659 1.591l9.581 9.581c.699.699 1.78.872 2.607.33a18.095 18.095 0 005.223-5.223c.542-.827.369-1.908-.33-2.607L11.16 3.66A2.25 2.25 0 009.568 3z" /> <path stroke-linecap="round" stroke-linejoin="round" d="M6 6h.008v.008H6V6z" /> </svg> <span id="footerPriceText" class="mx-1"></span> <span id="selectionCompleteIndicator" style="display: none;" title="Konfiguracja kompletna, gotowe do zakupu"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-white"> <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 3h1.386c.51 0 .955.343 1.087.835l.383 1.437M7.5 14.25a3 3 0 00-3 3h15.75m-12.75-3h11.218c1.121-2.3 2.1-4.684 2.924-7.138a60.114 60.114 0 00-16.536-1.84M7.5 14.25L5.106 5.272M6 20.25a.75.75 0 11-1.5 0 .75.75 0 011.5 0zm12.75 0a.75.75 0 11-1.5 0 .75.75 0 011.5 0z" /> </svg> </span> </div>
    </div>

    </body>
</html>
